(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{389:function(s,e,t){"use strict";t.r(e);var n=t(4),a=Object(n.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("blockquote",[e("p",[s._v("本文介绍如何使用 "),e("code",[s._v("Nginx")]),s._v(" 配置 "),e("code",[s._v("UDP/TCP/WebSocket")]),s._v(" 反向代理。怎样实现 UDP 的反向代理，"),e("code",[s._v("Nginx")]),s._v(" 从 1.9.13 起开始发布 "),e("code",[s._v("ngx_stream_core_module")]),s._v(" 模块不仅能支持 "),e("code",[s._v("TCP")]),s._v(" 代理及负载均衡，其实也是支持 UDP 协议的。")])]),s._v(" "),e("h2",{attrs:{id:"安装编译"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装编译"}},[s._v("#")]),s._v(" 安装编译")]),s._v(" "),e("p",[e("code",[s._v("ngx_stream_core_module")]),s._v(" 这个模块并不会默认启用，需要在编译时通过指定 "),e("code",[s._v("--with-stream")]),s._v(" 参数来激活这个模块。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ yum -y install proc* openssl* pcre*\n$ wget http://nginx.org/download/nginx-1.10.3.tar.gz\n$ tar zxvf nginx-1.10.3.tar.gz\n$ cd nginx-1.10.3\n$ ./configure  --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-threads --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-http_spdy_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'\n$ make\n$ make install\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h2",{attrs:{id:"配置-stream-模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-stream-模块"}},[s._v("#")]),s._v(" 配置 stream 模块")]),s._v(" "),e("h3",{attrs:{id:"http-代理配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-代理配置"}},[s._v("#")]),s._v(" HTTP 代理配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("stream {\n    server {\n        listen 9958 udp;\n        proxy_pass vpn.ykw.xyz:9958;\n    }\n\n    server {\n        listen 9958;\n        proxy_pass vpn.ykw.xyz:9958;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"udp-代理配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#udp-代理配置"}},[s._v("#")]),s._v(" UDP 代理配置")]),s._v(" "),e("p",[s._v("UDP 负载均衡解决了两个关键点：高可用性和横向扩展。UDP 设计是不保证端至端传送数据的，因此需要在客户端软件来处理网络级错误和重传机制。")]),s._v(" "),e("p",[s._v("stream 模块必需在 nginx.conf 中配置，下面配置为 DNS 代理配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$ mv nginx.conf{,.bak}\n$ vim  /etc/nginx/nginx.conf\nworker_processes auto;\nerror_log /var/log/nginx_error.log info;\nevents {\n    worker_connections  1024;\n}\nstream {\n    upstream dns {\n        server 192.168.0.1:53;\n        server dns.example.com:53;\n    }\n    server {\n        listen 127.0.0.1:53 udp;\n        proxy_responses 1;\n        proxy_timeout 20s;\n        proxy_pass dns;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h2",{attrs:{id:"nginx-代理-websocket"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-代理-websocket"}},[s._v("#")]),s._v(" Nginx 代理 WebSocket")]),s._v(" "),e("p",[s._v("下面介绍如何在 Nginx 中配置 WebSocket 代理。")]),s._v(" "),e("h3",{attrs:{id:"什么是-websocket"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是-websocket"}},[s._v("#")]),s._v(" 什么是 WebSocket")]),s._v(" "),e("p",[e("code",[s._v("WebSocket")]),s._v(" 是一种网络传输协议，可在单个 TCP 连接上进行全双工通信，位于 OSI 模型的应用层。"),e("code",[s._v("WebSocket")]),s._v(" 中的握手和 HTTP 中的握手过程兼容，且可以使用 HTTP 中的 Upgrade 协议头将连接从 HTTP 升级到 "),e("code",[s._v("WebSocket")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"代理结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代理结构"}},[s._v("#")]),s._v(" 代理结构")]),s._v(" "),e("p",[e("code",[s._v("WebSocket")]),s._v(" 可以工作在 "),e("code",[s._v("80/443")]),s._v(" 端口，并且使用 "),e("code",[s._v("ws://")]),s._v(" 或 "),e("code",[s._v("wss://")]),s._v(" 标记协议类型。可以 nginx 代理 "),e("code",[s._v("WebSocket")]),s._v("，实现从 "),e("code",[s._v("HTTP/1.1")]),s._v(" 到 "),e("code",[s._v("Websocket")]),s._v(" 转化，结构图如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Client HTTPS <--wss--\x3e Nginx Websocket Proxy <-- ws --\x3e App Server\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"websocket-代理配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#websocket-代理配置"}},[s._v("#")]),s._v(" WebSocket 代理配置")]),s._v(" "),e("p",[s._v("该方法也可用于对 Kubernetes API 的代理。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("http {\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        ''      close;\n    }\n\n    server {\n        ...\n\n        location /chat/ {\n            proxy_pass http://backend;\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("说明：")]),s._v(" "),e("p",[s._v("关键部分是在 HTTP 的请求中添加了如下 header，将协议从 HTTP1.1 升级到 WebSocket：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("proxy_set_header Upgrade $http_upgrade;\nproxy_set_header Connection $connection_upgrade;\n\n# 响应\nHTTP/1.1 101 Switching Protocols\nUpgrade: websocket\nConnection: Upgrade\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h2",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),e("ol",[e("li",[s._v("http://nginx.org/en/docs/stream/ngx_stream_core_module.html")]),s._v(" "),e("li",[s._v("https://www.hi-linux.com/posts/14615.html")]),s._v(" "),e("li",[s._v("http://nginx.org/en/docs/http/websocket.html")])])])}),[],!1,null,null,null);e.default=a.exports}}]);