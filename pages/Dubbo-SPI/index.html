<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dubbo SPI 详解 | Young&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="Young丶java后端技术博客,专注后端学习与总结。擅长spring boot,JAVA基础总结,等方面的知识,关注spring,架构,elasticsearch,mysql领域.">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9c8cf8c.css" as="style"><link rel="preload" href="/assets/js/app.6558865c.js" as="script"><link rel="preload" href="/assets/js/2.583df165.js" as="script"><link rel="preload" href="/assets/js/59.fc7519d9.js" as="script"><link rel="prefetch" href="/assets/js/10.5e061793.js"><link rel="prefetch" href="/assets/js/100.f158fbbd.js"><link rel="prefetch" href="/assets/js/101.97f7473e.js"><link rel="prefetch" href="/assets/js/102.eb5ae778.js"><link rel="prefetch" href="/assets/js/103.6700fe38.js"><link rel="prefetch" href="/assets/js/104.cf4e477a.js"><link rel="prefetch" href="/assets/js/105.d64538f4.js"><link rel="prefetch" href="/assets/js/106.cf32e7c7.js"><link rel="prefetch" href="/assets/js/107.227af51d.js"><link rel="prefetch" href="/assets/js/108.930ed4f6.js"><link rel="prefetch" href="/assets/js/109.bc3d1a91.js"><link rel="prefetch" href="/assets/js/11.c260de17.js"><link rel="prefetch" href="/assets/js/110.e467adf9.js"><link rel="prefetch" href="/assets/js/111.cb6c54db.js"><link rel="prefetch" href="/assets/js/112.8d38ba40.js"><link rel="prefetch" href="/assets/js/113.47b60d34.js"><link rel="prefetch" href="/assets/js/114.53420071.js"><link rel="prefetch" href="/assets/js/115.858785eb.js"><link rel="prefetch" href="/assets/js/116.95ada16c.js"><link rel="prefetch" href="/assets/js/117.e5f521ed.js"><link rel="prefetch" href="/assets/js/118.814720b9.js"><link rel="prefetch" href="/assets/js/119.c5c90afc.js"><link rel="prefetch" href="/assets/js/12.db817585.js"><link rel="prefetch" href="/assets/js/120.60b49c87.js"><link rel="prefetch" href="/assets/js/121.a616e563.js"><link rel="prefetch" href="/assets/js/122.c69a4ebd.js"><link rel="prefetch" href="/assets/js/123.9edd985e.js"><link rel="prefetch" href="/assets/js/124.401bfd54.js"><link rel="prefetch" href="/assets/js/125.d4d0a42b.js"><link rel="prefetch" href="/assets/js/126.d46bfdc5.js"><link rel="prefetch" href="/assets/js/127.b3a21be0.js"><link rel="prefetch" href="/assets/js/128.2722ab0b.js"><link rel="prefetch" href="/assets/js/13.fd3eb24c.js"><link rel="prefetch" href="/assets/js/14.695f7d95.js"><link rel="prefetch" href="/assets/js/15.55fde81d.js"><link rel="prefetch" href="/assets/js/16.7cdc1294.js"><link rel="prefetch" href="/assets/js/17.b6cc527c.js"><link rel="prefetch" href="/assets/js/18.512015df.js"><link rel="prefetch" href="/assets/js/19.64474d57.js"><link rel="prefetch" href="/assets/js/20.1dd97260.js"><link rel="prefetch" href="/assets/js/21.7e691bea.js"><link rel="prefetch" href="/assets/js/22.32e9141c.js"><link rel="prefetch" href="/assets/js/23.63138d3b.js"><link rel="prefetch" href="/assets/js/24.e584cd4d.js"><link rel="prefetch" href="/assets/js/25.6fc3eeb0.js"><link rel="prefetch" href="/assets/js/26.0f22e48b.js"><link rel="prefetch" href="/assets/js/27.4fdc574f.js"><link rel="prefetch" href="/assets/js/28.c2b43481.js"><link rel="prefetch" href="/assets/js/29.1a8f640c.js"><link rel="prefetch" href="/assets/js/3.8b355a30.js"><link rel="prefetch" href="/assets/js/30.6eb69c64.js"><link rel="prefetch" href="/assets/js/31.201c1c59.js"><link rel="prefetch" href="/assets/js/32.b99b5337.js"><link rel="prefetch" href="/assets/js/33.58185a6a.js"><link rel="prefetch" href="/assets/js/34.19832557.js"><link rel="prefetch" href="/assets/js/35.17ba6cf1.js"><link rel="prefetch" href="/assets/js/36.134ec142.js"><link rel="prefetch" href="/assets/js/37.ce010d5a.js"><link rel="prefetch" href="/assets/js/38.67d66d12.js"><link rel="prefetch" href="/assets/js/39.43556e25.js"><link rel="prefetch" href="/assets/js/4.b3bee27c.js"><link rel="prefetch" href="/assets/js/40.fab7741a.js"><link rel="prefetch" href="/assets/js/41.9bab045a.js"><link rel="prefetch" href="/assets/js/42.5fdd9c6d.js"><link rel="prefetch" href="/assets/js/43.869cecd0.js"><link rel="prefetch" href="/assets/js/44.cbb6a48f.js"><link rel="prefetch" href="/assets/js/45.f59e42d1.js"><link rel="prefetch" href="/assets/js/46.0ea023ce.js"><link rel="prefetch" href="/assets/js/47.c3f2a821.js"><link rel="prefetch" href="/assets/js/48.4fe9f8fc.js"><link rel="prefetch" href="/assets/js/49.1b8014ec.js"><link rel="prefetch" href="/assets/js/5.7d22774e.js"><link rel="prefetch" href="/assets/js/50.4c446bce.js"><link rel="prefetch" href="/assets/js/51.f4e67f87.js"><link rel="prefetch" href="/assets/js/52.8f8faeb9.js"><link rel="prefetch" href="/assets/js/53.6bef61bb.js"><link rel="prefetch" href="/assets/js/54.c5d847f2.js"><link rel="prefetch" href="/assets/js/55.3ad61741.js"><link rel="prefetch" href="/assets/js/56.33ec1024.js"><link rel="prefetch" href="/assets/js/57.270bfb0e.js"><link rel="prefetch" href="/assets/js/58.11f84f55.js"><link rel="prefetch" href="/assets/js/6.16ec3428.js"><link rel="prefetch" href="/assets/js/60.963f9cec.js"><link rel="prefetch" href="/assets/js/61.18e798f5.js"><link rel="prefetch" href="/assets/js/62.0acfdc73.js"><link rel="prefetch" href="/assets/js/63.59232fb7.js"><link rel="prefetch" href="/assets/js/64.e6186e20.js"><link rel="prefetch" href="/assets/js/65.d51e01c7.js"><link rel="prefetch" href="/assets/js/66.35d4ace5.js"><link rel="prefetch" href="/assets/js/67.d5d2490c.js"><link rel="prefetch" href="/assets/js/68.485caaa6.js"><link rel="prefetch" href="/assets/js/69.d527a11e.js"><link rel="prefetch" href="/assets/js/7.c078098e.js"><link rel="prefetch" href="/assets/js/70.e41bae47.js"><link rel="prefetch" href="/assets/js/71.3c4ae398.js"><link rel="prefetch" href="/assets/js/72.7dc219ab.js"><link rel="prefetch" href="/assets/js/73.88c80541.js"><link rel="prefetch" href="/assets/js/74.785a3b81.js"><link rel="prefetch" href="/assets/js/75.7a427044.js"><link rel="prefetch" href="/assets/js/76.d1b62bd2.js"><link rel="prefetch" href="/assets/js/77.a7a1cf37.js"><link rel="prefetch" href="/assets/js/78.00d15d87.js"><link rel="prefetch" href="/assets/js/79.c3a3a87f.js"><link rel="prefetch" href="/assets/js/8.525fd03f.js"><link rel="prefetch" href="/assets/js/80.6f7b688a.js"><link rel="prefetch" href="/assets/js/81.d389ade2.js"><link rel="prefetch" href="/assets/js/82.5a09265a.js"><link rel="prefetch" href="/assets/js/83.af881e6d.js"><link rel="prefetch" href="/assets/js/84.c50064da.js"><link rel="prefetch" href="/assets/js/85.58ae344c.js"><link rel="prefetch" href="/assets/js/86.3c880b88.js"><link rel="prefetch" href="/assets/js/87.ec9a9605.js"><link rel="prefetch" href="/assets/js/88.25a9f5e9.js"><link rel="prefetch" href="/assets/js/89.44bf0353.js"><link rel="prefetch" href="/assets/js/9.4293706c.js"><link rel="prefetch" href="/assets/js/90.146147c7.js"><link rel="prefetch" href="/assets/js/91.a8ad3ccc.js"><link rel="prefetch" href="/assets/js/92.f6870269.js"><link rel="prefetch" href="/assets/js/93.60d7826f.js"><link rel="prefetch" href="/assets/js/94.0127ed63.js"><link rel="prefetch" href="/assets/js/95.75f3c35f.js"><link rel="prefetch" href="/assets/js/96.708eeac4.js"><link rel="prefetch" href="/assets/js/97.648108b1.js"><link rel="prefetch" href="/assets/js/98.a5ea4ebc.js"><link rel="prefetch" href="/assets/js/99.1df8fb3e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9c8cf8c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Young's blog" class="logo"> <span class="site-name can-hide">Young's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章1</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/andanyang/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.png"> <div class="blogger-info"><h3>Young</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章1</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/andanyang/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/Dubbo/" class="sidebar-link">Dubbo入门</a></li><li><a href="/pages/Dubbo-SPI/" aria-current="page" class="active sidebar-link">Dubbo SPI 详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_3-1-核心静态变量" class="sidebar-link">3.1 核心静态变量</a></li><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_3-2-loadingstrategy-是如何加载的" class="sidebar-link">3.2 LoadingStrategy 是如何加载的？</a></li><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_3-3-核心成员变量" class="sidebar-link">3.3 核心成员变量</a></li><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_4-1-测试-demo" class="sidebar-link">4.1 测试 demo</a></li><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_4-2-获得扩展实例" class="sidebar-link">4.2 获得扩展实例</a></li><li class="sidebar-sub-header level2"><a href="/pages/Dubbo-SPI/#_4-3-获得所有扩展类" class="sidebar-link">4.3 获得所有扩展类</a></li></ul></li><li><a href="/pages/Dubbo-SPI-Adaptive/" class="sidebar-link">Dubbo SPI的自适应扩展原理</a></li><li><a href="/Dubbo/6_Extension/" class="sidebar-link">Dubbo的6 种扩展机制</a></li><li><a href="/pages/Dubbo-face/" class="sidebar-link">Dubbo面试题</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Dubbo" title="分类" data-v-06225672>Dubbo</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/andanyoung" target="_blank" title="作者" class="beLink" data-v-06225672>andanyang</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-04-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Dubbo SPI 详解<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_1-为什么不使用-jdk-spi"><a href="#_1-为什么不使用-jdk-spi" class="header-anchor">#</a> 1. 为什么不使用 JDK SPI</h1> <p>既然已经有了 JDK SPI 为什么还需要 Dubbo SPI 呢？</p> <p>技术的出现通常都是为了解决现有问题，通过之前的 demo，不难发现 JDK SPI 机制就存在以下一些问题：</p> <ol><li>实现类会被全部遍历并且实例化，假如我们只需要使用其中的一个实现，这在实现类很多的情况下无疑是对机器资源巨大的浪费，</li> <li>无法按需获取实现类，不够灵活，我们需要遍历一遍所有实现类才能找到指定实现。</li></ol> <p>Dubbo SPI 以 JDK SPI 为参考做出了改进设计，进行了性能优化以及功能增强，Dubbo SPI 机制的出现解决了上述问题。除此之外，Dubbo 的 SPI 还支持自适应扩展以及 IOC 和 AOP 等高级特性。</p> <p>JDK SPI 原理，请移步这篇文章：<a href="https://blog.csdn.net/agonie201218/article/details/124663738" target="_blank" rel="noopener noreferrer">聊聊 Java SPI 机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="_2-dubbo-spi-配置"><a href="#_2-dubbo-spi-配置" class="header-anchor">#</a> 2.Dubbo SPI 配置</h1> <p>Dubbo SPI 的配置做出了改进，在 Dubbo 中有三种不同的目录可以存放 SPI 配置，用途也不同。</p> <ul><li>**META-INF/services/ **目录：此目录配置文件用于兼容 JDK SPI 。</li> <li><strong>META-INF/dubbo/</strong> 目录：此目录用于存放用户自定义 SPI 配置文件。</li> <li><strong>META-INF/dubbo/internal/</strong> 目录：此目录用于存放 Dubbo 内部使用的 SPI 配置文件。</li></ul> <p>并且配置文件中可以配置成 Key-Value 形式，key 为扩展名，value 为具体实现类。有了扩展名就可以动态根据名字来定位到具体的实现类，并且可以针对性的实例化需要的实现类。比如指定 zookeeper，就知道要使用 zookeeper 作为注册中心的实现。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>zookeeper=org.apache.dubbo.registry.zookeeper.ZookeeperRegistryFactory
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Dubbo 并未使用 Java SPI，而是重新实现了一套功能更强的 SPI 机制。Dubbo SPI 的相关逻辑被封装在了 ExtensionLoader 类中，通过 ExtensionLoader，我们可以加载指定的实现类。</p> <p>除了对应目录的配置，还需要 <strong>@SPI</strong> 注解的配合，被修饰的接口表示这是一个扩展接口，<code>@SPI</code> 的 value 表示这个扩展接口的默认扩展实现的扩展名，扩展名就是配置文件中对应实现类配置信息的 key。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//dubbo=org.apache.dubbo.rpc.protocol.dubbo.DubboProtocol
@SPI(&quot;dubbo&quot;)
public interface Protocol {
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>除此之外，还需要 <strong>@Adaptive</strong>注解配合，被他修饰的类会生成 Dubbo 的适配器，Adaptive 注解比较复杂，关于这个注解我们后续文章会再详细讲解。</p> <h1 id="_3-extensionloader"><a href="#_3-extensionloader" class="header-anchor">#</a> 3. ExtensionLoader</h1> <p>我们这里以 dubbo 2.7 为例</p> <p>之前的文章我们提到过，dubbo-common 模块中的 extension 包包含了 Dubbo SPI 的逻辑，而 ExtensionLoader 就位于其中，Dubbo SPI 的核心逻辑几乎都封装在 ExtensionLoader 这个类里，其地位你可以类比为 JDK SPI 中的 java.util.ServiceLoader。</p> <p>学习 ExtensionLoader 首先了解以下几个关键属性。</p> <h2 id="_3-1-核心静态变量"><a href="#_3-1-核心静态变量" class="header-anchor">#</a> 3.1 核心静态变量</h2> <p>1、EXTENSION_LOADERS</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 扩展接口和ExtensionLoader的关系
private static final ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = new ConcurrentHashMap&lt;&gt;(64);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这个字段保存了扩展接口和 ExtensionLoader 之间的映射关系，一个扩展接口对应一个 ExtensionLoader。key 为接口，value 为 ExtensionLoader。</p> <p><img src="http://md7.admin4j.com/blog/Dubboimage-20230411092506254.png" alt="image-20230411092506254"></p> <p>2、EXTENSION_INSTANCES</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//扩展接口实现类和实例对象的关系
private final ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; extensionInstances = new ConcurrentHashMap&lt;&gt;(64);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这个字段保存了扩展接口扩展实现类和实例对象之间的关系，key 为扩展实现类，value 为实例对象。</p> <p>3、strategies 加载策略</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//加载策略
private static volatile LoadingStrategy[] strategies = loadLoadingStrategies();
import static java.util.ServiceLoader.load;
private static LoadingStrategy[] loadLoadingStrategies() {
    return stream(load(LoadingStrategy.class).spliterator(), false)
           .sorted().toArray(LoadingStrategy[]::new);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>strategies 对应的是 Dubbo 内部实现的三个加载策略，分别对应之前提到的三个不同的 SPI 配置目录，接口的继承关系如下。他们的实现中无非就是包含了两个信息：加载目录和优先级。</p> <p><img src="http://md7.admin4j.com/blog/Dubboimage-20230411093438221.png" alt="image-20230411093438221"></p> <p>每个实现类都继承了优先级接口<code>Prioritized</code>，所以不同加载策略的加载优先级不同，对应的优先级是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DubboInternalLoadingStrategy 大于&gt;DubboLoadingStrategy 大于&gt;ServicesLoadingStrateg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应目录的<strong>优先级</strong>分别是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>META-INF/dubbo/internal/&gt;META-INF/dubbo/&gt;META-INF/services/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_3-2-loadingstrategy-是如何加载的"><a href="#_3-2-loadingstrategy-是如何加载的" class="header-anchor">#</a> 3.2 <strong>LoadingStrategy 是如何加载的？</strong></h2> <p>需要注意的是，<code>LoadingStrategy</code>的控制了 Dubbo 内部实现的加载策略，那他自身又是如何加载的呢？</p> <p>其实根据上面的代码就可以发现<code>LoadingStrategy</code>正是依赖 JDK SPI 机制来加载的，在<code>loadLoadingStrategies()</code>方法中调用了<code>ServiceLoader.load()</code>方法，从<code>META-INF/services</code>文件夹下的<code>org.apache.dubbo.common.extension.LoadingStrategy</code>文件中读取到了具体实现类并且依次加载。所以一定程度上来说，Dubbo SPI 机制正是依赖于 JDK SPI 机制。</p> <p><img src="http://md7.admin4j.com/blog/Dubboimage-20230411093917438.png" alt="LoadingStrategy是如何加载的"></p> <h2 id="_3-3-核心成员变量"><a href="#_3-3-核心成员变量" class="header-anchor">#</a> 3.3 核心成员变量</h2> <p>1、type：与当前 ExtensionLoader 绑定的扩展接口类型。</p> <p>2、cachedNames：存储了扩展实现类和扩展名的关系，key 为扩展实现类，value 为对应扩展名。</p> <p>3、cachedClasses：存储了扩展名和扩展实现类之间的关系。key 为扩展名，value 为扩展实现类，这个 map 可以和 cachedNames 对应着理解，他们存贮内容是相反的关系，算是一种空间换时间的技巧。</p> <p>4、cachedInstances：存储了扩展实现类类名与实现类的实例对象之间的关系，key 为扩展实现名，value 为实例对象。</p> <p>5、cachedDefaultName：@SPI 注解配置的默认扩展名。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//扩展接口类型
private final Class&lt;?&gt; type;
//存储了扩展实现类和扩展名的关系
private final ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = new ConcurrentHashMap&lt;&gt;();
//存储了扩展名和扩展实现类之间的关系
private final Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = new Holder&lt;&gt;();
//存储了扩展实现类类名与实例对象之间的关系
private final ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;&gt;();
//扩展接口对@SPI注解配置的value
private String cachedDefaultName;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h1 id="_4-dubbo-spi-加载原理"><a href="#_4-dubbo-spi-加载原理" class="header-anchor">#</a> 4.<strong>Dubbo SPI 加载原理</strong></h1> <h2 id="_4-1-测试-demo"><a href="#_4-1-测试-demo" class="header-anchor">#</a> 4.1 测试 demo</h2> <p>为了方便调试并且抓住核心原理，其实可以跟 JDK SPI 一样写一个 demo，我们直接复用上次的扩展接口和实现类，但是这次是用 Dubbo SPI 的形式加载。配置文件需要重新写一份，写成 key-value 形式，并且放在<code>META-INF/dubbo</code>文件夹下。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@SPI
public interface MySPI {
    void say();
}
public class HelloMySPI implements MySPI{
    @Override
    public void say() {
        System.out.println(&quot;HelloMySPI say:hello&quot;);
    }
}
public class GoodbyeMySPI implements MySPI {
    @Override
    public void say() {
        System.out.println(&quot;GoodbyeMySPI say:Goodbye&quot;);
    }
}
public static void main(String[] args) {
    ExtensionLoader&lt;MySPI&gt; extensionLoader = ExtensionLoader.getExtensionLoader(MySPI.class);
    MySPI hello = extensionLoader.getExtension(&quot;hello&quot;);
    hello.say();
    MySPI goodbye = extensionLoader.getExtension(&quot;goodbye&quot;);
    goodbye.say();
}
//配置文件 META-INF/dubbo/org.daley.spi.demo.MySPI
goodbye=org.daley.spi.demo.GoodbyeMySPI
hello=org.daley.spi.demo.HelloMySPI

// 输出结果
HelloMySPI say:hello
GoodbyeMySPI say:Goodbye
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>一定记得给接口标记@SPI 注解，否则会抛出以下错误。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: Extension type (interface org.daley.spi.demo.MySPI) is not an extension, because it is NOT annotated with @SPI!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_4-2-获得扩展实例"><a href="#_4-2-获得扩展实例" class="header-anchor">#</a> 4.2 获得扩展实例</h2> <p>在上述 demo 中，我们首先通过 ExtensionLoader 的 getExtensionLoader 方法获取一个 ExtensionLoader 实例，然后再通过 ExtensionLoader 的 getExtension 方法获取拓展类对象。</p> <p>在调用<code>getExtensionLoader()</code>时会首先尝试从<code>EXTENSION_LOADERS</code>中根据扩展点类型获得<code>ExtensionLoader</code>，如果未命中缓存，则会新创建一个<code>ExtensionLoader</code>，然后返回。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public static &lt;T&gt; ExtensionLoader&lt;T&gt; getExtensionLoader(Class&lt;T&gt; type) {
   ……省略校验逻辑
    ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);
    if (loader == null) {
        EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader&lt;T&gt;(type));
        loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);
    }
    return loader;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在<code>ExtensionLoader</code>的构造方法中，会绑定扩展点接口类型，并且会绑定扩展对象工厂<code>ExtensionFactory objectFactory</code>，这也是一个扩展点，为了避免越套越深，这里不做深入追踪。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private ExtensionLoader(Class&lt;?&gt; type) {
    this.type = type;
    objectFactory =
            (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建好<code>ExtensionLoader</code>之后，便可以调用<code>getExtension()</code>方法。核心在于获得扩展实现，首先检查缓存，缓存未命中则创建扩展对象，然后设置到 holder 中。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ublic T getExtension(String name) {
    return getExtension(name, true);
}

public T getExtension(String name, boolean wrap) {
    if (StringUtils.isEmpty(name)) {
        throw new IllegalArgumentException(&quot;Extension name == null&quot;);
    }
    if (&quot;true&quot;.equals(name)) {
        // 获取默认的扩展实现类
        return getDefaultExtension();
    }
    //用于持有目标对象
    final Holder&lt;Object&gt; holder = getOrCreateHolder(name);
    Object instance = holder.get();
    if (instance == null) {
        synchronized (holder) {
            instance = holder.get();
            if (instance == null) {
                //创建扩展实例
                instance = createExtension(name, wrap);
                //设置到holder中
                holder.set(instance);
            }
        }
    }
    return (T) instance;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>创建扩展实例方法<code>createExtension()</code>主要包含以下逻辑：</p> <ol><li>通过 <code>getExtensionClasses()</code> 获取所有的拓展类</li> <li>通过反射创建拓展对象</li> <li>向拓展对象中注入依赖（可以想象到，这里存在依赖其他 SPI 扩展点的情况，递归注入）</li> <li>将拓展对象包裹在相应的 Wrapper 对象中</li> <li>如果实现了<code>Lifecycle</code>接口，执行生命周期的初始化方法</li></ol> <p>步骤 1 是加载拓展类的关键，步骤 3 和 4 是 Dubbo IOC 与 AOP 的具体实现，注意 IOC 和 AOP 是一种思想，别和 Spring 的 IOC、AOP 混淆。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private T createExtension(String name, boolean wrap) {
    //关键代码！从配置文件中加载所有的拓展类，可得到“配置项名称”到“配置类”的映射关系表
    Class&lt;?&gt; clazz = getExtensionClasses().get(name);
    if (clazz == null || unacceptableExceptions.contains(name)) {
        throw findException(name);
    }
    try {
        // 通过反射创建实例
        T instance = (T) EXTENSION_INSTANCES.get(clazz);
        if (instance == null) {
            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.getDeclaredConstructor().newInstance());
            instance = (T) EXTENSION_INSTANCES.get(clazz);
        }
        // 向实例中注入依赖
        injectExtension(instance);


        if (wrap) {

            List&lt;Class&lt;?&gt;&gt; wrapperClassesList = new ArrayList&lt;&gt;();
            if (cachedWrapperClasses != null) {
                wrapperClassesList.addAll(cachedWrapperClasses);
                wrapperClassesList.sort(WrapperComparator.COMPARATOR);
                Collections.reverse(wrapperClassesList);
            }

            if (CollectionUtils.isNotEmpty(wrapperClassesList)) {
                // 循环创建 Wrapper 实例
                for (Class&lt;?&gt; wrapperClass : wrapperClassesList) {
                    Wrapper wrapper = wrapperClass.getAnnotation(Wrapper.class);
                    if (wrapper == null
                            || (ArrayUtils.contains(wrapper.matches(), name) &amp;&amp; !ArrayUtils.contains(wrapper.mismatches(), name))) {
                        // 将当前 instance 作为参数传给 Wrapper 的构造方法，并通过反射创建 Wrapper 实例。
                        // 然后向 Wrapper 实例中注入依赖，最后将 Wrapper 实例再次赋值给 instance 变量
                        instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));
                    }
                }
            }
        }
    //执行生命周期初始化方法 initialize()
        initExtension(instance);
        return instance;
    } catch (Throwable t) {
        ……
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_4-3-获得所有扩展类"><a href="#_4-3-获得所有扩展类" class="header-anchor">#</a> 4.3 获得所有扩展类</h2> <p>我们在根据名称获得指定拓展类之前，首先需要根据配置文件解析出拓展项名称到拓展类的映射 Map（Map&lt;名称, 拓展类&gt;），之后再根据拓展项名称从映射关系 Map 中根据 name 取出相应的拓展类即可。</p> <p>在获得全部扩展名与扩展类关系<code>classes</code>时，如果还未创建，会有个双重检查的过程以防止并发加载。通过检查后会调用 <code>loadExtensionClasses()</code> 加载扩展类。相关过程的代码分析如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() {
    // 从缓存中获取已加载的拓展类
    Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();
    // DBC 双重检查
    if (classes == null) {
        synchronized (cachedClasses) {
            classes = cachedClasses.get();
            if (classes == null) {
                // 加载所有拓展类逻辑
                classes = loadExtensionClasses();
                cachedClasses.set(classes);
            }
        }
    }
    return classes;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>loadExtensionClasses()</code>主要做了两件事，一是解析@SPI 注解设置默认扩展名，二是在这里会扫描 Dubbo 那三个配置文件夹下的所有配置文件，具体注释如下。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() {
    cacheDefaultExtensionName();

    Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = new HashMap&lt;&gt;();
    // 从三种加载策略中获得扩展实现类，对应加载指定文件夹下的配置文件，这里的加载策略已经根据优先级排好了顺序，数字越小越优先
    for (LoadingStrategy strategy : strategies) {
        loadDirectory(extensionClasses, strategy.directory(), type.getName(), strategy.preferExtensionClassLoader(),
                strategy.overridden(), strategy.excludedPackages());
        // 此处为了兼容阿里巴巴到Apache的版本过度
        loadDirectory(extensionClasses, strategy.directory(), type.getName().replace(&quot;org.apache&quot;, &quot;com.alibaba&quot;),
                strategy.preferExtensionClassLoader(), strategy.overridden(), strategy.excludedPackages());
    }

    return extensionClasses;
}

// 设置默认扩展名
private void cacheDefaultExtensionName() {
    // 获取 SPI 注解，这里的 type 变量是在调用 getExtensionLoader 方法时传入的
    final SPI defaultAnnotation = type.getAnnotation(SPI.class);
    if (defaultAnnotation == null) {
        return;
    }
    //从@SPI注解获得默认实现扩展实现名
    String value = defaultAnnotation.value();
    if ((value = value.trim()).length() &gt; 0) {
        // 对 SPI 注解内容进行切分
        String[] names = NAME_SEPARATOR.split(value);
        // 检测 SPI 注解内容是否合法，不合法则抛出异常
        if (names.length &gt; 1) {
            throw new IllegalStateException(&quot;More than 1 default extension name on extension &quot; + type.getName()
                    + &quot;: &quot; + Arrays.toString(names));
        }
        if (names.length == 1) {
            // 设置默认名称，参考 getDefaultExtension 方法
            cachedDefaultName = names[0];
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>可以看出，关键的逻辑应该在<code>loadDirectory()</code>方法中。<code>loadDirectory()</code> 方法先通过 <code>classLoader</code> 获取所有资源链接，然后再通过<code>loadResource</code> 方法加载资源。我们继续跟下去，看一下 loadResource 方法的实现。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private void loadResource(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader,
                          java.net.URL resourceURL, boolean overridden, String... excludedPackages) {
    try {
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(resourceURL.openStream(), StandardCharsets.UTF_8))) {
            String line;
            String clazz = null;
            // 按行读取配置内容
            while ((line = reader.readLine()) != null) {
                // 定位 # 字符
                final int ci = line.indexOf('#');
                if (ci &gt;= 0) {
                    // 截取 # 之前的字符串，# 之后的内容为注释，需要忽略
                    line = line.substring(0, ci);
                }
                line = line.trim();
                if (line.length() &gt; 0) {
                    try {
                        String name = null;
                        // 以等于号 = 为界，截取键与值
                        int i = line.indexOf('=');
                        if (i &gt; 0) {
                            name = line.substring(0, i).trim();
                            clazz = line.substring(i + 1).trim();
                        } else {
                            clazz = line;
                        }
                        if (StringUtils.isNotEmpty(clazz) &amp;&amp; !isExcluded(clazz, excludedPackages)) {
                            // 加载类，并通过 loadClass 方法对类进行缓存
                            loadClass(extensionClasses, resourceURL, Class.forName(clazz, true, classLoader), name, overridden);
                        }
                    } catch (Throwable t) {
                        IllegalStateException e = new IllegalStateException(
                                &quot;Failed to load extension class (interface: &quot; + type + &quot;, class line: &quot; + line + &quot;) in &quot; + resourceURL +
                                        &quot;, cause: &quot; + t.getMessage(), t);
                        exceptions.put(line, e);
                    }
                }
            }
        }
    } catch (Throwable t) {
        logger.error(&quot;Exception occurred when loading extension class (interface: &quot; +
                type + &quot;, class file: &quot; + resourceURL + &quot;) in &quot; + resourceURL, t);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>loadResource 方法用于读取和解析配置文件，并通过反射加载类，最后调用 loadClass 方法进行其他操作。loadClass 方法用于主要用于操作缓存，该方法的逻辑如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private void loadClass(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name,
                       boolean overridden) throws NoSuchMethodException {
    if (!type.isAssignableFrom(clazz)) {
        throw new IllegalStateException(&quot;Error occurred when loading extension class (interface: &quot; +
                type + &quot;, class line: &quot; + clazz.getName() + &quot;), class &quot;
                + clazz.getName() + &quot; is not subtype of interface.&quot;);
    }
    // 检测目标类上是否有 Adaptive 注解
    if (clazz.isAnnotationPresent(Adaptive.class)) {
        // 设置 cachedAdaptiveClass缓存
        cacheAdaptiveClass(clazz, overridden);

        // 检测 clazz 是否是 Wrapper 类型
    } else if (isWrapperClass(clazz)) {
        // 存储 clazz 到 cachedWrapperClasses 缓存中
        cacheWrapperClass(clazz);

    } else {
        // 程序进入此分支，表明 clazz 是一个普通的拓展类
        clazz.getConstructor();
        // 检测 clazz 是否有默认的构造方法，如果没有，则抛出异常
        if (StringUtils.isEmpty(name)) {
            // 如果 name 为空，则尝试从 Extension 注解中获取 name，或使用小写的类名作为 name
            name = findAnnotationName(clazz);
            if (name.length() == 0) {
                throw new IllegalStateException(
                        &quot;No such extension name for the class &quot; + clazz.getName() + &quot; in the config &quot; + resourceURL);
            }
        }
        // 切分 name
        String[] names = NAME_SEPARATOR.split(name);
        if (ArrayUtils.isNotEmpty(names)) {
            cacheActivateClass(clazz, names[0]);
            for (String n : names) {
                // 存储 Class 到名称的映射关系
                cacheName(clazz, n);
                // 存储名称到 Class 的映射关系
                saveInExtensionClass(extensionClasses, clazz, n, overridden);
            }
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>如上，loadClass 方法操作了不同的缓存，比如解析@Adaptive 注解设置到 cachedAdaptiveClass 缓存；如果是 wrapper 类设置到 cachedWrapperClasses 缓存；保存拓展类和拓展名到 cachedNames 缓存等等。</p> <h1 id="_5-总结"><a href="#_5-总结" class="header-anchor">#</a> 5. 总结</h1> <p>在我们了解了各种实现细节后，最后可以总结一下各种知识点。</p> <ol><li>dubbo 的 ExtensionLoader 对应 JDK 的 ServiceLoader，包含了加载所需要的各种上下文信息，一个扩展接口对应一个 ExtensionLoader，关系维护在一个 Map 中。</li> <li>在尝试获取拓展类的时候，才开始实例化，按需加载，这种懒加载是一种对 JDK SPI 的优化。</li> <li>Dubbo SPI 会从三个配置目录按照优先级加载配置，加载策略是依赖 JDK SPI 加载的。</li> <li>加载配置的时候会加载所有配置的 Class 类型，然后把拓展名和拓展类的类型维护一个映射（key-value），这也是按需加载，灵活使用的基础。</li></ol></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/andanyang/vuepress-theme-vdoing/edit/master/docs/Dubbo/0002.Dubbo SPI 详解.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/07/21, 07:56:36</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/Dubbo/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Dubbo入门</div></a> <a href="/pages/Dubbo-SPI-Adaptive/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Dubbo SPI的自适应扩展原理</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/Dubbo/" class="prev">Dubbo入门</a></span> <span class="next"><a href="/pages/Dubbo-SPI-Adaptive/">Dubbo SPI的自适应扩展原理</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/digitalization/DX_technology_business/"><div>
            数字化转型的核心是技术？还是业务？
            <!----></div></a> <span class="date">07-13</span></dt></dl><dl><dd>02</dd> <dt><a href="/digitalization/terms_digital_factory/"><div>
            聊聊数字化工厂的一些术语
            <!----></div></a> <span class="date">07-13</span></dt></dl><dl><dd>03</dd> <dt><a href="/digitalization/BI_underlying_logic/"><div>
            BI的底层逻辑：业务流、信息流和数据流
            <!----></div></a> <span class="date">07-13</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1218853253@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/andanyang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>Young | <a href="https://github.com/andanyoung/young-blog/blob/master/LICENSE" target="_blank">MIT License</a> <br/> <a  href="https://beian.miit.gov.cn/" target="_blank">浙ICP备20002744号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.6558865c.js" defer></script><script src="/assets/js/2.583df165.js" defer></script><script src="/assets/js/59.fc7519d9.js" defer></script>
  </body>
</html>
