<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MyBatis 架构与原理到执行流程 | Young&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="Young丶java后端技术博客,专注后端学习与总结。擅长spring boot,JAVA基础总结,等方面的知识,关注spring,架构,elasticsearch,mysql领域.">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9c8cf8c.css" as="style"><link rel="preload" href="/assets/js/app.4cd86b41.js" as="script"><link rel="preload" href="/assets/js/2.d1119784.js" as="script"><link rel="preload" href="/assets/js/20.40ed6860.js" as="script"><link rel="prefetch" href="/assets/js/10.730cc33a.js"><link rel="prefetch" href="/assets/js/11.d1f87d63.js"><link rel="prefetch" href="/assets/js/12.4aca44c1.js"><link rel="prefetch" href="/assets/js/13.6b78182a.js"><link rel="prefetch" href="/assets/js/14.367745cf.js"><link rel="prefetch" href="/assets/js/15.c20fcdee.js"><link rel="prefetch" href="/assets/js/16.2b737092.js"><link rel="prefetch" href="/assets/js/17.89bb9f70.js"><link rel="prefetch" href="/assets/js/18.06851bba.js"><link rel="prefetch" href="/assets/js/19.12bc1800.js"><link rel="prefetch" href="/assets/js/21.5c8e29ac.js"><link rel="prefetch" href="/assets/js/22.3f1ac88e.js"><link rel="prefetch" href="/assets/js/23.0f6c4fc2.js"><link rel="prefetch" href="/assets/js/24.c10a49a3.js"><link rel="prefetch" href="/assets/js/25.004ee4c5.js"><link rel="prefetch" href="/assets/js/26.b8c3e290.js"><link rel="prefetch" href="/assets/js/27.22147769.js"><link rel="prefetch" href="/assets/js/28.e36e589d.js"><link rel="prefetch" href="/assets/js/29.17cebbd7.js"><link rel="prefetch" href="/assets/js/3.867c813a.js"><link rel="prefetch" href="/assets/js/30.a3c72481.js"><link rel="prefetch" href="/assets/js/31.511b3f69.js"><link rel="prefetch" href="/assets/js/32.7f0fc1b1.js"><link rel="prefetch" href="/assets/js/33.6cdaa214.js"><link rel="prefetch" href="/assets/js/34.1780e7f3.js"><link rel="prefetch" href="/assets/js/35.29229406.js"><link rel="prefetch" href="/assets/js/36.6ce4ae19.js"><link rel="prefetch" href="/assets/js/37.a44bdb9a.js"><link rel="prefetch" href="/assets/js/38.76a3215c.js"><link rel="prefetch" href="/assets/js/39.f05d0806.js"><link rel="prefetch" href="/assets/js/4.0eade8ff.js"><link rel="prefetch" href="/assets/js/40.b7d743f6.js"><link rel="prefetch" href="/assets/js/41.da4f472e.js"><link rel="prefetch" href="/assets/js/42.94aa9e35.js"><link rel="prefetch" href="/assets/js/43.2fbe0510.js"><link rel="prefetch" href="/assets/js/44.43b4ddc2.js"><link rel="prefetch" href="/assets/js/45.74c6ae67.js"><link rel="prefetch" href="/assets/js/46.57718ecf.js"><link rel="prefetch" href="/assets/js/47.569e5254.js"><link rel="prefetch" href="/assets/js/48.f6aae826.js"><link rel="prefetch" href="/assets/js/49.d691584a.js"><link rel="prefetch" href="/assets/js/5.b37386e0.js"><link rel="prefetch" href="/assets/js/50.fccff498.js"><link rel="prefetch" href="/assets/js/51.b62d5d60.js"><link rel="prefetch" href="/assets/js/52.db74baec.js"><link rel="prefetch" href="/assets/js/53.3076b5fc.js"><link rel="prefetch" href="/assets/js/54.fd279287.js"><link rel="prefetch" href="/assets/js/55.8415e55b.js"><link rel="prefetch" href="/assets/js/56.427e2c13.js"><link rel="prefetch" href="/assets/js/57.c386aa37.js"><link rel="prefetch" href="/assets/js/58.34a09a47.js"><link rel="prefetch" href="/assets/js/59.850e7488.js"><link rel="prefetch" href="/assets/js/6.253cb709.js"><link rel="prefetch" href="/assets/js/60.37471fae.js"><link rel="prefetch" href="/assets/js/61.96747036.js"><link rel="prefetch" href="/assets/js/62.0cce6d03.js"><link rel="prefetch" href="/assets/js/63.73b028ad.js"><link rel="prefetch" href="/assets/js/64.28f562ad.js"><link rel="prefetch" href="/assets/js/65.7f37c3e9.js"><link rel="prefetch" href="/assets/js/66.e2566bbd.js"><link rel="prefetch" href="/assets/js/67.e093e3ce.js"><link rel="prefetch" href="/assets/js/68.209e2c32.js"><link rel="prefetch" href="/assets/js/69.01ad0d61.js"><link rel="prefetch" href="/assets/js/7.baba38db.js"><link rel="prefetch" href="/assets/js/70.581f4a90.js"><link rel="prefetch" href="/assets/js/71.397058b1.js"><link rel="prefetch" href="/assets/js/72.1e8455fe.js"><link rel="prefetch" href="/assets/js/73.f63bbc3f.js"><link rel="prefetch" href="/assets/js/74.917d3065.js"><link rel="prefetch" href="/assets/js/75.8349ed04.js"><link rel="prefetch" href="/assets/js/76.897d2627.js"><link rel="prefetch" href="/assets/js/77.7f092513.js"><link rel="prefetch" href="/assets/js/78.08ecfec4.js"><link rel="prefetch" href="/assets/js/8.29973322.js"><link rel="prefetch" href="/assets/js/9.8b5d754c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9c8cf8c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Young's blog" class="logo"> <span class="site-name can-hide">Young's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章1</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/andanyang/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.png"> <div class="blogger-info"><h3>Young</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Spring/" class="nav-link">Spring</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章1</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/andanyang/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/jdbc-demo/" class="sidebar-link">JDBC简单的示例</a></li><li><a href="/pages/mybatis-source/" aria-current="page" class="active sidebar-link">MyBatis 架构与原理到执行流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#mybatis-功能架构讲解" class="sidebar-link">MyBatis 功能架构讲解</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#mybatis-框架架构讲解" class="sidebar-link">MyBatis 框架架构讲解：</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_1、sqlsessionfactorybuilder" class="sidebar-link">1、SqlSessionFactoryBuilder</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_2、sqlsessionfactory-对象由-sqlsessionfactorybuilder-创建" class="sidebar-link">2、SqlSessionFactory 对象由 SqlSessionFactoryBuilder 创建：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/mybatis-source/#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header level3"><a href="/pages/mybatis-source/#介绍一下-mappedstatement" class="sidebar-link">介绍⼀下 MappedStatement ：</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_3、sqlsession" class="sidebar-link">3、SqlSession</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_4、executor" class="sidebar-link">4、Executor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/mybatis-source/#获得-sqlsession" class="sidebar-link">获得 sqlSession</a></li><li class="sidebar-sub-header level3"><a href="/pages/mybatis-source/#执行-sqlsession-中的-api-以-selectlist-为例" class="sidebar-link">执⾏ sqlsession 中的 api,以 selectList 为例</a></li><li class="sidebar-sub-header level3"><a href="/pages/mybatis-source/#源码剖析-executor" class="sidebar-link">源码剖析-executor</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_5、statementhandler" class="sidebar-link">5、StatementHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#_6、resultsethandler" class="sidebar-link">6、ResultSetHandler</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#源码剖析-getmapper" class="sidebar-link">源码剖析-getMapper()</a></li><li class="sidebar-sub-header level2"><a href="/pages/mybatis-source/#源码剖析-invoke" class="sidebar-link">源码剖析-invoke()</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=MyBatis" title="分类" data-v-06225672>MyBatis</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/andanyoung" target="_blank" title="作者" class="beLink" data-v-06225672>andanyang</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-03-24</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">MyBatis 架构与原理到执行流程<!----></h1>  <div class="theme-vdoing-content content__default"><blockquote><p>Mybatis 经过一系列操作最终封装成 <code>Statement\PreparedStatement</code>,交个 JDBC 处理，所以我们需要回归下 JDBC。参考<a href="https://blog.csdn.net/agonie201218/article/details/129157261?spm=1001.2014.3001.5501" target="_blank" rel="noopener noreferrer">JDBC 简单的示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h1 id="mybatis-功能架构设计"><a href="#mybatis-功能架构设计" class="header-anchor">#</a> MyBatis 功能架构设计</h1> <p><img src="https://img-blog.csdnimg.cn/img_convert/07c7d3e87703e205c6527c66c36f8be2.png#pic_center" alt="MyBatis功能架构设计"></p> <h2 id="mybatis-功能架构讲解"><a href="#mybatis-功能架构讲解" class="header-anchor">#</a> MyBatis 功能架构讲解</h2> <p>我们把 Mybatis 的功能架构分为三层：</p> <p>(1)API 接口层：提供给外部使用的接口 API，开发人员通过这些本地 API 来操纵数据库。接口层一接收到调用请求就会调用数据处理层来完成具体的数据处理。</p> <p>(2)数据处理层：负责具体的 SQL 查找、SQL 解析、SQL 执行和执行结果映射处理等。它主要的目的是根据调用的请求完成一次数据库操作。</p> <p>(3)基础支撑层：负责最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，这些都是共用的东西，将他们抽取出来作为最基础的组件。为上层的数据处理层提供最基础的支撑。</p> <h1 id="mybatis-框架架构"><a href="#mybatis-框架架构" class="header-anchor">#</a> MyBatis 框架架构</h1> <p><img src="https://img-blog.csdnimg.cn/img_convert/060b74d05c8c9ae64833c83f1db8147c.png#pic_center" alt="MyBatis框架架构 "></p> <h2 id="mybatis-框架架构讲解"><a href="#mybatis-框架架构讲解" class="header-anchor">#</a> MyBatis 框架架构讲解：</h2> <p>这张图从上往下看。MyBatis 的初始化，会从 mybatis-config.xml 配置文件，解析构造成 Configuration 这个类，就是图中的红框。</p> <p>(1)加载配置：配置来源于两个地方，一处是配置文件，一处是 Java 代码的注解，将 SQL 的配置信息加载成为一个个 MappedStatement 对象（包括了传入参数映射配置、执行的 SQL 语句、结果映射配置），存储在内存中。</p> <p>(2)SQL 解析：当 API 接口层接收到调用请求时，会接收到传入 SQL 的 ID 和传入对象（可以是 Map、JavaBean 或者基本数据类型），Mybatis 会根据 SQL 的 ID 找到对应的 MappedStatement，然后根据传入参数对象对 MappedStatement 进行解析，解析后可以得到最终要执行的 SQL 语句和参数。</p> <p>(3)SQL 执行：将最终得到的 SQL 和参数拿到数据库进行执行，得到操作数据库的结果。</p> <p>(4)结果映射：将操作数据库的结果按照映射的配置进行转换，可以转换成 HashMap、JavaBean 或者基本数据类型，并将最终结果返回。</p> <h1 id="mybatis-核心类"><a href="#mybatis-核心类" class="header-anchor">#</a> MyBatis 核心类</h1> <h2 id="_1、sqlsessionfactorybuilder"><a href="#_1、sqlsessionfactorybuilder" class="header-anchor">#</a> 1、SqlSessionFactoryBuilder</h2> <p>每一个 MyBatis 的应用程序的入口是 SqlSessionFactoryBuilder。</p> <p>它的作用是通过 XML 配置文件创建 Configuration 对象（当然也可以在程序中自行创建），然后通过 build 方法创建 SqlSessionFactory 对象。没有必要每次访问 Mybatis 就创建一次 SqlSessionFactoryBuilder，通常的做法是创建一个全局的对象就可以了。示例程序如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private static SqlSessionFactoryBuilder sqlSessionFactoryBuilder;
private static SqlSessionFactory sqlSessionFactory;

private static void init() throws IOException {
        String resource = &quot;mybatis-config.xml&quot;;
        Reader reader = Resources.getResourceAsReader(resource);
        sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
        sqlSessionFactory = sqlSessionFactoryBuilder.build(reader);
}
        org.apache.ibatis.session.Configuration 是mybatis初始化的核心。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>mybatis-config.xml 中的配置，最后会解析 xml 成 Configuration 这个类。</p> <p>SqlSessionFactoryBuilder 根据传入的数据流(XML)生成 Configuration 对象，然后根据 Configuration 对象创建默认的 SqlSessionFactory 实例。</p> <h2 id="_2、sqlsessionfactory-对象由-sqlsessionfactorybuilder-创建"><a href="#_2、sqlsessionfactory-对象由-sqlsessionfactorybuilder-创建" class="header-anchor">#</a> 2、SqlSessionFactory 对象由 SqlSessionFactoryBuilder 创建：</h2> <p>它的主要功能是创建 SqlSession 对象，和 SqlSessionFactoryBuilder 对象一样，没有必要每次访问 Mybatis 就创建一次 SqlSessionFactory，通常的做法是创建一个全局的对象就可以了。SqlSessionFactory 对象一个必要的属性是 Configuration 对象，它是保存 Mybatis 全局配置的一个配置对象，通常由 SqlSessionFactoryBuilder 从 XML 配置文件创建。这里给出一个简单的示例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE configuration PUBLIC
        &quot;-//mybatis.org//DTD Config 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;
&lt;configuration&gt;
    &lt;!-- 配置别名 --&gt;
    &lt;typeAliases&gt;
        &lt;typeAlias type=&quot;org.iMybatis.abc.dao.UserDao&quot; alias=&quot;UserDao&quot; /&gt;
        &lt;typeAlias type=&quot;org.iMybatis.abc.dto.UserDto&quot; alias=&quot;UserDto&quot; /&gt;
    &lt;/typeAliases&gt;

    &lt;!-- 配置环境变量 --&gt;
    &lt;environments default=&quot;development&quot;&gt;
        &lt;environment id=&quot;development&quot;&gt;
            &lt;transactionManager type=&quot;JDBC&quot; /&gt;
            &lt;dataSource type=&quot;POOLED&quot;&gt;
                &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;
                &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://127.0.0.1:3306/iMybatis?characterEncoding=GBK&quot; /&gt;
                &lt;property name=&quot;username&quot; value=&quot;iMybatis&quot; /&gt;
                &lt;property name=&quot;password&quot; value=&quot;iMybatis&quot; /&gt;
            &lt;/dataSource&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;

    &lt;!-- 配置mappers --&gt;
    &lt;mappers&gt;
        &lt;mapper resource=&quot;org/iMybatis/abc/dao/UserDao.xml&quot; /&gt;
    &lt;/mappers&gt;

&lt;/configuration&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <p>MyBatis 在初始化的时候，会将 MyBatis 的配置信息全部加载到内存中，使⽤ org.apache.ibatis.session.Configuration 实例来维护</p> <p>下⾯进⼊对配置⽂件解析部分： ⾸先对 Configuration 对象进⾏介绍：</p> <p>Configuration 对象的结构和 xml 配置⽂件的对象⼏乎相同。 回顾⼀下 xml 中的配置标签有哪些： properties (属性)，settings (设置)，typeAliases (类型别名)，typeHandlers (类型处理 器)，objectFactory (对象⼯⼚)，mappers (映射器)等 Configuration 也有对应的对象属性来封 装它们 也就是说，初始化配置⽂件信息的本质就是创建 Configuration 对象，将解析的 xml 数据封装到 Configuration 内部属性中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>InputStream resourceAsStream = Resources.getResourceAsStream(&quot;sqlMapConfig.xml&quot;);
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
---

public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {
        try {
            // 创建 XMLConfigBuilder, XMLConfigBuilder是专门解析mybatis的配置文件的类
            XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
            // 执行 XML 解析
            // 创建 DefaultSqlSessionFactory 对象
            return build(parser.parse());
        } catch (Exception e) {
            throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);
        } finally {
            ErrorContext.instance().reset();
            try {
                inputStream.close();
            } catch (IOException e) {
                // Intentionally ignore. Prefer previous error.
            }
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>/**
     * 解析 XML
     *
     * 具体 MyBatis 有哪些 XML 标签，参见 《XML 映射配置文件》http://www.mybatis.org/mybatis-3/zh/configuration.html
     *
     * @param root 根节点
     */
    private void parseConfiguration(XNode root) {
        try {
            //issue #117 read properties first
            // 解析 &lt;properties /&gt; 标签
            propertiesElement(root.evalNode(&quot;properties&quot;));
            // 解析 &lt;settings /&gt; 标签
            Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));
            // 加载自定义的 VFS 实现类
            loadCustomVfs(settings);
            // 解析 &lt;typeAliases /&gt; 标签
            typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));
            // 解析 &lt;plugins /&gt; 标签
            pluginElement(root.evalNode(&quot;plugins&quot;));
            // 解析 &lt;objectFactory /&gt; 标签
            objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));
            // 解析 &lt;objectWrapperFactory /&gt; 标签
            objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));
            // 解析 &lt;reflectorFactory /&gt; 标签
            reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));
            // 赋值 &lt;settings /&gt; 到 Configuration 属性
            settingsElement(settings);
            // read it after objectFactory and objectWrapperFactory issue #631
            // 解析 &lt;environments /&gt; 标签
            environmentsElement(root.evalNode(&quot;environments&quot;));
            // 解析 &lt;databaseIdProvider /&gt; 标签
            databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));
            // 解析 &lt;typeHandlers /&gt; 标签
            typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));
            // 解析 &lt;mappers /&gt; 标签
            mapperElement(root.evalNode(&quot;mappers&quot;));
        } catch (Exception e) {
            throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);
        }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="介绍一下-mappedstatement"><a href="#介绍一下-mappedstatement" class="header-anchor">#</a> 介绍⼀下 MappedStatement ：</h3> <p>作⽤：MappedStatement 与 Mapper 配置⽂件中的⼀个 select/update/insert/delete 节点相对应。 mapper 中配置的标签都被封装到了此对象中，主要⽤途是描述⼀条 SQL 语句。</p> <p><strong>初始化过程：</strong> 回顾刚开 始介绍的加载配置⽂件的过程中，会对 mybatis-config.xml 中的各个标签都进⾏ 解析，其中有 mappers 标签⽤来引⼊ mapper.xml ⽂件或者配置 mapper 接⼝的⽬录</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;select id=&quot;getUser&quot; resultType=&quot;user&quot; &gt;
 select * from user where id=#{id}
&lt;/select&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样的⼀个 select 标签会在初始化配置⽂件时被解析封装成⼀个 MappedStatement 对象，然后存储在 Configuration 对象的 mappedStatements 属性中，mappedStatements 是⼀个 HashMap，存储时 key =全限定类名+⽅法名，value =对应的 MappedStatement 对象</p> <p>在 configuration<strong>中对应的属性为</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Map&lt;String, MappedStatement&gt; mappedStatements = new StrictMap&lt;MappedStatement&gt;
(&quot;Mapped Statements collection&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在 XMLConfigBuilder 中的处理：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private void parseConfiguration(XNode root) {
     try {
         //省略其他标签的处理
         mapperElement(root.evalNode(&quot;mappers&quot;));
     } catch (Exception e) {
         throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause:&quot; + e, e);
     }
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>到此对 xml 配置⽂件的解析就结束了，回到步骤 2.中调⽤的重载 build ⽅法</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 5.调⽤的重载⽅法
public SqlSessionFactory build(Configuration config) {
 //创建了 DefaultSqlSessionFactory 对象，传⼊ Configuration 对象。
 return new DefaultSqlSessionFactory(config);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3、sqlsession"><a href="#_3、sqlsession" class="header-anchor">#</a> 3、SqlSession</h2> <p>SqlSession 是⼀个接⼝，它类似于数据库的 session 概念，由于不是线程安全的。通常将它与 ThreadLocal 绑定，⼀个会话使⽤⼀ 个 SqlSession,并且在使⽤完毕后需要 close。它有两个实现类：DefaultSqlSession (默认)和 SqlSessionManager (弃⽤，不做介绍) SqlSession 是 MyBatis 中⽤于和数据库交互的顶层类，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class DefaultSqlSession implements SqlSession {
    private final Configuration configuration;
    private final Executor executor;
    /**
     * 是否自动提交事务
     */
    private final boolean autoCommit;
    /**
     * 是否发生数据变更
     */
    private boolean dirty;
    /**
     * Cursor 数组
     */
    private List&lt;Cursor&lt;?&gt;&gt; cursorList;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>SqlSession 中的两个最重要的参数，configuration 与初始化时的相同，Executor 为执⾏器</p> <p>SqlSession ：默认创建 DefaultSqlSession 并且开启一级缓存，创建执行器 、赋值。</p> <p>SqlSession 有一个重要的方法 getMapper，顾名思义，这个方式是用来获取 Mapper 对象的。什么是 Mapper 对象？根据 Mybatis 的官方手册，应用程序除了要初始并启动 Mybatis 之外，还需要定义一些接口，接口里定义访问数据库的方法，存放接口的包路径下需要放置同名的 XML 配置文件。</p> <p>SqlSession 的 getMapper 方法是联系应用程序和 Mybatis 纽带，应用程序访问 getMapper 时，Mybatis 会根据传入的接口类型和对应的 XML 配置文件生成一个<strong>代理对象</strong>，这个代理对象就叫 Mapper 对象。应用程序获得 Mapper 对象后，就应该通过这个 Mapper 对象来访问 Mybatis 的 SqlSession 对象，这样就达到里插入到 Mybatis 流程的目的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SqlSession session= sqlSessionFactory.openSession();
UserDao userDao = session.getMapper(UserDao.class);
UserDto user = new UserDto();
user.setUsername(&quot;iMybatis&quot;);
List&lt;UserDto&gt; users = userDao.queryUsers(user);

---
public interface UserDao {
    public List&lt;UserDto&gt; queryUsers(UserDto user) throws Exception;
}

---
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;org.iMybatis.abc.dao.UserDao&quot;&gt;
	&lt;select id=&quot;queryUsers&quot; parameterType=&quot;UserDto&quot; resultType=&quot;UserDto&quot;
		useCache=&quot;false&quot;&gt;
			&lt;![CDATA[
				select * from t_user t where t.username = #{username}
        	]]&gt;
    &lt;/select&gt;
&lt;/mapper&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="_4、executor"><a href="#_4、executor" class="header-anchor">#</a> 4、Executor</h2> <p>Executor 对象在创建 Configuration 对象的时候创建，并且缓存在 Configuration 对象里。Executor 对象的主要功能是调用 StatementHandler 访问数据库，并将查询结果存入缓存中（如果配置了缓存的话）。</p> <p>Executor 也是⼀个接⼝，他有三个常⽤的实现类：</p> <ul><li><p>BatchExecutor (重⽤语句并执⾏批量更新）</p></li> <li><p>ReuseExecutor (重⽤预处理语句 prepared statements）</p></li> <li><p>SimpleExecutor (普通的执⾏器，默认)</p> <p>继续分析，初始化完毕后，我们就要执⾏ SQL 了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SqlSession sqlSession = factory.openSession();
List&lt;User&gt; list = sqlSession.selectList(&quot;com.admin4j.mapper.UserMapper.getUserByName&quot;);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h3 id="获得-sqlsession"><a href="#获得-sqlsession" class="header-anchor">#</a> 获得 sqlSession</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>//6. 进入openSession方法
  @Override
  public SqlSession openSession() {
      //getDefaultExecutorType()传递的是SimpleExecutor
      return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);
  }

---
	//7. 进入openSessionFromDataSource。
  //ExecutorType 为Executor的类型，TransactionIsolationLevel为事务隔离级别，autoCommit是否开启事务
  //openSession的多个重载方法可以指定获得的SeqSession的Executor类型和事务的处理
  private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
      Transaction tx = null;
      try {
          // 获得 Environment 对象
          final Environment environment = configuration.getEnvironment();
          // 创建 Transaction 对象
          final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
          tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
          // 创建 Executor 对象
          final Executor executor = configuration.newExecutor(tx, execType);
          // 创建 DefaultSqlSession 对象
          return new DefaultSqlSession(configuration, executor, autoCommit);
      } catch (Exception e) {
          // 如果发生异常，则关闭 Transaction 对象
          closeTransaction(tx); // may have fetched a connection so lets call close()
          throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);
      } finally {
          ErrorContext.instance().reset();
      }
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="执行-sqlsession-中的-api-以-selectlist-为例"><a href="#执行-sqlsession-中的-api-以-selectlist-为例" class="header-anchor">#</a> 执⾏ sqlsession 中的 api,以 selectList 为例</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>    //8.进入selectList方法，多个重载方法
    @Override
    public &lt;E&gt; List&lt;E&gt; selectList(String statement) {
        return this.selectList(statement, null);
    }

    @Override
    public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter) {
        return this.selectList(statement, parameter, RowBounds.DEFAULT);
    }

    @Override
    public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) {
        try {
            // 获得 MappedStatement 对象
            // 根据传⼊的全限定名+⽅法名从映射的Map中取出MappedStatement对象
            MappedStatement ms = configuration.getMappedStatement(statement);
            // 执行查询
            //调⽤Executor中的⽅法处理
            //RowBounds是⽤来逻辑分⻚
            // wrapCollection(parameter)是⽤来装饰集合或者数组参数
            return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);
        } catch (Exception e) {
            throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + e, e);
        } finally {
            ErrorContext.instance().reset();
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="源码剖析-executor"><a href="#源码剖析-executor" class="header-anchor">#</a> 源码剖析-executor</h3> <p>再创建 SqlSeeeion 时会创建 executor</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 创建 Executor 对象
final Executor executor = configuration.newExecutor(tx, execType);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再 Configuration 类中创建 Executor 对象源码，其中如果开启缓存的换就将创建的 executor 设为 CachingExecutor 的代理，<code>executor = new CachingExecutor(executor)</code>，并返回 CachingExecutor</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * 创建 Executor 对象
 *
 * @param transaction 事务对象
 * @param executorType 执行器类型
 * @return Executor 对象
 */
public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
    // 获得执行器类型
    executorType = executorType == null ? defaultExecutorType : executorType; // 使用默认
    executorType = executorType == null ? ExecutorType.SIMPLE : executorType; // 使用 ExecutorType.SIMPLE
    // 创建对应实现的 Executor 对象
    Executor executor;
    if (ExecutorType.BATCH == executorType) {
        executor = new BatchExecutor(this, transaction);
    } else if (ExecutorType.REUSE == executorType) {
        executor = new ReuseExecutor(this, transaction);
    } else {
        executor = new SimpleExecutor(this, transaction);
    }
    // 如果开启缓存，创建 CachingExecutor 对象，进行包装
    if (cacheEnabled) {
        executor = new CachingExecutor(executor);
    }
    // 应用插件
    executor = (Executor) interceptorChain.pluginAll(executor);
    return executor;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>继续源码中的步骤，进⼊ executor.query()</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//此⽅法在SimpleExecutor的⽗类BaseExecutor中实现
    @Override
    public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {
        // 根据传⼊的参数动态获得SQL语句，最后返回⽤BoundSql对象表示
        BoundSql boundSql = ms.getBoundSql(parameterObject);
        // 为本次查询创建缓存的Key
        CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);
        // 查询
        return query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

---
//进⼊query的重载⽅法中
public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)
            throws SQLException {

        // 从 MappedStatement 中获取 Cache，注意这里的 Cache 是从MappedStatement中获取的
        // 也就是我们上面解析Mapper中&lt;cache/&gt;标签中创建的，它保存在Configration中
        // 我们在初始化解析xml时分析过每一个MappedStatement都有一个Cache对象，就是这里
        Cache cache = ms.getCache();

        // 如果配置文件中没有配置 &lt;cache&gt;，则 cache 为空
        if (cache != null) {
            //如果需要刷新缓存的话就刷新：flushCache=&quot;true&quot;
            flushCacheIfRequired(ms);
            if (ms.isUseCache() &amp;&amp; resultHandler == null) {
                // 暂时忽略，存储过程相关
                ensureNoOutParams(ms, boundSql);
                @SuppressWarnings(&quot;unchecked&quot;)
                // 从二级缓存中，获取结果
                List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);
                if (list == null) {
                    // 如果没有值，则执行查询，这个查询实际也是先走一级缓存查询，一级缓存也没有的话，则进行DB查询
                    list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
                    // 缓存查询结果
                    tcm.putObject(cache, key, list); // issue #578 and #116
                }
                // 如果存在，则直接返回结果
                return list;
            }
        }
        // 不使用缓存，则从数据库中查询(会查一级缓存) 调用父类的方法
        return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }


---  父类BaseExecutor
    public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing a query&quot;).object(ms.getId());
        // 已经关闭，则抛出 ExecutorException 异常
        if (closed) {
            throw new ExecutorException(&quot;Executor was closed.&quot;);
        }
        // 清空本地缓存，如果 queryStack 为零，并且要求清空本地缓存。
        if (queryStack == 0 &amp;&amp; ms.isFlushCacheRequired()) {
            clearLocalCache();
        }
        List&lt;E&gt; list;
        try {
            // queryStack + 1
            queryStack++;
            // 从一级缓存中，获取查询结果
            list = resultHandler == null ? (List&lt;E&gt;) localCache.getObject(key) : null;
            // 获取到，则进行处理
            if (list != null) {
                handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
            // 获得不到，则从数据库中查询
            } else {
                list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
            }
        } finally {
            // queryStack - 1
            queryStack--;
        }
        if (queryStack == 0) {
            // 执行延迟加载
            for (DeferredLoad deferredLoad : deferredLoads) {
                deferredLoad.load();
            }
            // issue #601
            // 清空 deferredLoads
            deferredLoads.clear();
            // 如果缓存级别是 LocalCacheScope.STATEMENT ，则进行清理
            if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
                // issue #482
                clearLocalCache();
            }
        }
        return list;
    }

 // 从数据库中读取操作
    private &lt;E&gt; List&lt;E&gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        List&lt;E&gt; list;
        // 在缓存中，添加占位对象。此处的占位符，和延迟加载有关，可见 `DeferredLoad#canLoad()` 方法
        localCache.putObject(key, EXECUTION_PLACEHOLDER);
        try {
            // 执行读操作
            list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
        } finally {
            // 从缓存中，移除占位对象
            localCache.removeObject(key);
        }
        // 添加到缓存中
        localCache.putObject(key, list);
        // 暂时忽略，存储过程相关
        if (ms.getStatementType() == StatementType.CALLABLE) {
            localOutputParameterCache.putObject(key, parameter);
        }
        return list;
    }

 --- 最终调用子类的doQuery 实现具体查询
 @Override
    public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
        Statement stmt = null;
        try {
            Configuration configuration = ms.getConfiguration();
            // 传入参数创建StatementHanlder对象来执行查询
            StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
            // 创建jdbc中的statement对象
            stmt = prepareStatement(handler, ms.getStatementLog());
            // 执行 StatementHandler  ，进行读操作
            return handler.query(stmt, resultHandler);
        } finally {
            // 关闭 StatementHandler 对象
            closeStatement(stmt);
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br></div></div><p>上述的 Executor.query()⽅法⼏经转折，最后会创建⼀个 StatementHandler 对象，然后将必要的参数传 递给 StatementHandler，使⽤ StatementHandler 来完成对数据库的查询，最终返回 List 结果集。 从上⾯的代码中我们可以看出，Executor 的功能和作⽤是</p> <ul><li>1、根据传递的参数，完成 SQL 语句的动态解析，⽣成 BoundSql 对象，供 StatementHandler 使⽤； -</li> <li>2、为查询创建缓存，以提⾼性能</li> <li>3、创建 JDBC 的<strong>Statement</strong>（PreparedStatement）连接对象，传递给<em>StatementHandler</em>对象，返回 List 查询结果。</li></ul> <h2 id="_5、statementhandler"><a href="#_5、statementhandler" class="header-anchor">#</a> 5、StatementHandler</h2> <p>StatementHandler 对象主要完成两个⼯作：</p> <ul><li>对于 JDBC 的 PreparedStatement 类型的对象，创建的过程中，我们使⽤的是 SQL 语句字符串会包含若⼲个？占位符，我们其后再对占位符进⾏设值。StatementHandler 通过 parameterize(statement)⽅法对 Statement 进⾏设值；</li> <li>StatementHandler 通过 List query(Statement statement, ResultHandler resultHandler)⽅法来 完成执⾏ Statement，和将 Statement 对象返回的 resultSet 封装成 List； 进⼊到 StatementHandler 的 parameterize(statement)⽅法的实现：</li></ul> <p>上方 SimpleExecutor.doQuery() 方法初始化 StatementHandler 和 Statement</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 传入参数创建StatementHanlder对象来执行查询
StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
// 创建jdbc中的statement对象
stmt = prepareStatement(handler, ms.getStatementLog());
// 执行 StatementHandler  ，进行读操作
return handler.query(stmt, resultHandler);

---
// 初始化 StatementHandler 对象
    private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {
        Statement stmt;
        // 获得 Connection 对象
        Connection connection = getConnection(statementLog);
        // 创建 Statement 或 PrepareStatement 对象
        stmt = handler.prepare(connection, transaction.getTimeout());
        // 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符
        handler.parameterize(stmt);
        return stmt;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>进⼊到 StatementHandler（PreparedStatementHandler） 的 parameterize(statement)⽅法的实现：</p> <blockquote><p>StatementHandler 包含各种 sql 参数 通过 <code>parameterHandler.setParameters((PreparedStatement) statement);</code>构建出一个 PreparedStatement 对象</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>public void parameterize(Statement statement) throws SQLException {
 //使⽤ParameterHandler对象来完成对Statement的设值
 parameterHandler.setParameters((PreparedStatement) statement);
}

---
 public void setParameters(PreparedStatement ps) {
        ErrorContext.instance().activity(&quot;setting parameters&quot;).object(mappedStatement.getParameterMap().getId());
        // 遍历 ParameterMapping 数组
        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();
        if (parameterMappings != null) {
            for (int i = 0; i &lt; parameterMappings.size(); i++) {
                // 获得 ParameterMapping 对象
                ParameterMapping parameterMapping = parameterMappings.get(i);
                if (parameterMapping.getMode() != ParameterMode.OUT) {
                    // 获得值
                    Object value;
                    String propertyName = parameterMapping.getProperty();
                    if (boundSql.hasAdditionalParameter(propertyName)) { // issue #448 ask first for additional params
                        value = boundSql.getAdditionalParameter(propertyName);
                    } else if (parameterObject == null) {
                        value = null;
                    } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                        value = parameterObject;
                    } else {
                        MetaObject metaObject = configuration.newMetaObject(parameterObject);
                        value = metaObject.getValue(propertyName);
                    }
                    // 获得 typeHandler、jdbcType 属性
                    TypeHandler typeHandler = parameterMapping.getTypeHandler();
                    JdbcType jdbcType = parameterMapping.getJdbcType();
                    if (value == null &amp;&amp; jdbcType == null) {
                        jdbcType = configuration.getJdbcTypeForNull();
                    }
                    // 设置 ? 占位符的参数
                    try {
                        typeHandler.setParameter(ps, i + 1, value, jdbcType);
                    } catch (TypeException | SQLException e) {
                        throw new TypeException(&quot;Could not set parameters for mapping: &quot; + parameterMapping + &quot;. Cause: &quot; + e, e);
                    }
                }
            }
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>从上述的代码可以看到,StatementHandler 的 parameterize(Statement)⽅法调⽤了 ParameterHandler 的 setParameters(statement)⽅法， ParameterHandler 的 setParameters(Statement )⽅法负责根据我们输⼊的参数，对 statement 对象的 ?占位符处进⾏赋值。 进⼊到 StatementHandler 的 List query(Statement statement, ResultHandler resultHandler)⽅法的实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Override
public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException {
	PreparedStatement ps = (PreparedStatement) statement;
	// 执行查询
	ps.execute();
	// 处理返回结果
	return resultSetHandler.handleResultSets(ps);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从上述代码我们可以看出，StatementHandler 的<code>List query(Statement statement, ResultHandler resultHandler)</code>⽅法的实现，是调⽤了 ResultSetHandler 的 handleResultSets(Statement)⽅法。</p> <p>ResultSetHandler 的 handleResultSets(Statement)⽅法会将 Statement 语句执⾏后⽣成的 resultSet 结 果集转换成 List 结果集</p> <h2 id="_6、resultsethandler"><a href="#_6、resultsethandler" class="header-anchor">#</a> 6、ResultSetHandler</h2> <p>处理查询结果。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> 	//
    // HANDLE RESULT SETS
    //
    // 处理 {@link java.sql.ResultSet} 结果集
    @Override
    public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException {
        ErrorContext.instance().activity(&quot;handling results&quot;).object(mappedStatement.getId());

        // 多 ResultSet 的结果集合，每个 ResultSet 对应一个 Object 对象。而实际上，每个 Object 是 List&lt;Object&gt; 对象。
        // 在不考虑存储过程的多 ResultSet 的情况，普通的查询，实际就一个 ResultSet ，也就是说，multipleResults 最多就一个元素。
        final List&lt;Object&gt; multipleResults = new ArrayList&lt;&gt;();

        int resultSetCount = 0;
        // 获得首个 ResultSet 对象，并封装成 ResultSetWrapper 对象
        ResultSetWrapper rsw = getFirstResultSet(stmt);

        // 获得 ResultMap 数组
        // 在不考虑存储过程的多 ResultSet 的情况，普通的查询，实际就一个 ResultSet ，也就是说，resultMaps 就一个元素。
        List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();
        int resultMapCount = resultMaps.size();
        validateResultMapsCount(rsw, resultMapCount); // 校验
        while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) {
            // 获得 ResultMap 对象
            ResultMap resultMap = resultMaps.get(resultSetCount);
            // 处理 ResultSet ，将结果添加到 multipleResults 中
            handleResultSet(rsw, resultMap, multipleResults, null);
            // 获得下一个 ResultSet 对象，并封装成 ResultSetWrapper 对象
            rsw = getNextResultSet(stmt);
            // 清理
            cleanUpAfterHandlingResultSet();
            // resultSetCount ++
            resultSetCount++;
        }

        // 因为 `mappedStatement.resultSets` 只在存储过程中使用，本系列暂时不考虑，忽略即可
        String[] resultSets = mappedStatement.getResultSets();
        if (resultSets != null) {
            while (rsw != null &amp;&amp; resultSetCount &lt; resultSets.length) {
                ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);
                if (parentMapping != null) {
                    String nestedResultMapId = parentMapping.getNestedResultMapId();
                    ResultMap resultMap = configuration.getResultMap(nestedResultMapId);
                    handleResultSet(rsw, resultMap, null, parentMapping);
                }
                rsw = getNextResultSet(stmt);
                cleanUpAfterHandlingResultSet();
                resultSetCount++;
            }
        }

        // 如果是 multipleResults 单元素，则取首元素返回
        return collapseSingleResultList(multipleResults);
    }

---
// 处理 ResultSet ，将结果添加到 multipleResults 中
    private void handleResultSet(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Object&gt; multipleResults, ResultMapping parentMapping) throws SQLException {
        try {
            // 暂时忽略，因为只有存储过程的情况，调用该方法，parentMapping 为非空
            if (parentMapping != null) {
                handleRowValues(rsw, resultMap, null, RowBounds.DEFAULT, parentMapping);
            } else {
                // 如果没有自定义的 resultHandler ，则创建默认的 DefaultResultHandler 对象
                if (resultHandler == null) {
                    // 创建 DefaultResultHandler 对象
                    DefaultResultHandler defaultResultHandler = new DefaultResultHandler(objectFactory);
                    // 处理 ResultSet 返回的每一行 Row
                    handleRowValues(rsw, resultMap, defaultResultHandler, rowBounds, null);
                    // 添加 defaultResultHandler 的处理的结果，到 multipleResults 中
                    multipleResults.add(defaultResultHandler.getResultList());
                } else {
                    // 处理 ResultSet 返回的每一行 Row
                    handleRowValues(rsw, resultMap, resultHandler, rowBounds, null);
                }
            }
        } finally {
            // issue #228 (close resultsets)
            // 关闭 ResultSet 对象
            closeResultSet(rsw.getResultSet());
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h1 id="mapper-代理方式"><a href="#mapper-代理方式" class="header-anchor">#</a> Mapper 代理方式:</h1> <p>回顾下写法:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public static void main(String[] args) {
     //前三步都相同
     InputStream inputStream = Resources.getResourceAsStream(&quot;sqlMapConfig.xml&quot;);
     SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
     SqlSession sqlSession = factory.openSession();
     //这⾥不再调⽤SqlSession的api,⽽是获得了接⼝对象，调⽤接⼝中的⽅法。
     UserMapper mapper = sqlSession.getMapper(UserMapper.class);
     List&lt;User&gt; list = mapper.getUserByName(&quot;tom&quot;);
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>思考⼀个问题，通常的 Mapper 接⼝我们都没有实现的⽅法却可以使⽤，是为什么呢？答案很简单动态代理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;mappers&gt;
 &lt;mapper class=&quot;com.admin4j.mapper.UserMapper&quot;/&gt;
 &lt;package name=&quot;com.admin4j.mapper&quot;/&gt;
&lt;/mappers&gt;

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>当解析 mappers 标签时，它会判断解析到的是 mapper 配置⽂件时，会再将对应配置⽂件中的增删改查标签封装成 MappedStatement 对象，存⼊ mappedStatements 中。(上⽂介绍了)当判断解析到接⼝时，会建此接口对应的 MapperProxyFactory 对象，存⼊ HashMap 中，key =接⼝的字节码对象，value =此接口对应的 MapperProxyFactory 对象</li></ul> <h2 id="源码剖析-getmapper"><a href="#源码剖析-getmapper" class="header-anchor">#</a> 源码剖析-getMapper()</h2> <p>进⼊ sqlSession.getMapper(UserMapper.class )中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//DefaultSqlSession 中的 getMapper
 public &lt;T&gt; T getMapper(Class&lt;T&gt; type) {
 	return configuration.&lt;T&gt;getMapper(type, this);
 }

---
 //configuration 中的给 getMapper
 public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) {
	 return mapperRegistry.getMapper(type, sqlSession);
 }

---
 	//MapperRegistry 中的 getMapper
    public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) {
        // 获得 MapperProxyFactory 对象
        final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);
        // 不存在，则抛出 BindingException 异常
        if (mapperProxyFactory == null) {
            throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);
        }
        /// 通过动态代理工厂生成实例。
        try {
            return mapperProxyFactory.newInstance(sqlSession);
        } catch (Exception e) {
            throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);
        }
    }

---
//MapperProxyFactory 类中的 newInstance ⽅法
    public T newInstance(SqlSession sqlSession) {
        // 创建了JDK动态代理的invocationHandler接口的实现类mapperProxy
        final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);
        // 调用了重载方法
        return newInstance(mapperProxy);
    }

   protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) {

        return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[]{mapperInterface}, mapperProxy);
    }

 ---
    // 构造，传入了SqlSession，说明每个session中的代理对象的不同的！
    public MapperProxy(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache) {
        this.sqlSession = sqlSession;
        this.mapperInterface = mapperInterface;
        this.methodCache = methodCache;
    }



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h2 id="源码剖析-invoke"><a href="#源码剖析-invoke" class="header-anchor">#</a> 源码剖析-invoke()</h2> <div class="language- extra-class"><pre><code>@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    try {
        // 如果是 Object 定义的方法，直接调用
        if (Object.class.equals(method.getDeclaringClass())) {
            return method.invoke(this, args);

        } else if (isDefaultMethod(method)) {
            return invokeDefaultMethod(proxy, method, args);
        }
    } catch (Throwable t) {
        throw ExceptionUtil.unwrapThrowable(t);
    }
    // 获得 MapperMethod 对象
    final MapperMethod mapperMethod = cachedMapperMethod(method);
    // 重点在这：MapperMethod最终调用了执行的方法
    return mapperMethod.execute(sqlSession, args);
}
</code></pre></div><p>进⼊ execute ⽅法进⼊ execute ⽅法</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public Object execute(SqlSession sqlSession, Object[] args) {
        Object result;
        //判断mapper中的方法类型，最终调用的还是SqlSession中的方法
        switch (command.getType()) {
            case INSERT: {
                // 转换参数
                Object param = method.convertArgsToSqlCommandParam(args);
                // 执行 INSERT 操作
                // 转换 rowCount
                result = rowCountResult(sqlSession.insert(command.getName(), param));
                break;
            }
            case UPDATE: {
                // 转换参数
                Object param = method.convertArgsToSqlCommandParam(args);
                // 转换 rowCount
                result = rowCountResult(sqlSession.update(command.getName(), param));
                break;
            }
            case DELETE: {
                // 转换参数
                Object param = method.convertArgsToSqlCommandParam(args);
                // 转换 rowCount
                result = rowCountResult(sqlSession.delete(command.getName(), param));
                break;
            }
            case SELECT:
                // 无返回，并且有 ResultHandler 方法参数，则将查询的结果，提交给 ResultHandler 进行处理
                if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) {
                    executeWithResultHandler(sqlSession, args);
                    result = null;
                // 执行查询，返回列表
                } else if (method.returnsMany()) {
                    result = executeForMany(sqlSession, args);
                // 执行查询，返回 Map
                } else if (method.returnsMap()) {
                    result = executeForMap(sqlSession, args);
                // 执行查询，返回 Cursor
                } else if (method.returnsCursor()) {
                    result = executeForCursor(sqlSession, args);
                // 执行查询，返回单个对象
                } else {
                    // 转换参数
                    Object param = method.convertArgsToSqlCommandParam(args);
                    // 查询单条
                    result = sqlSession.selectOne(command.getName(), param);
                    if (method.returnsOptional() &amp;&amp;
                            (result == null || !method.getReturnType().equals(result.getClass()))) {
                        result = Optional.ofNullable(result);
                    }
                }
                break;
            case FLUSH:
                result = sqlSession.flushStatements();
                break;
            default:
                throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());
        }
        // 返回结果为 null ，并且返回类型为基本类型，则抛出 BindingException 异常
        if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) {
            throw new BindingException(&quot;Mapper method '&quot; + command.getName()
                    + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);
        }
        // 返回结果
        return result;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><h1 id="sqlsession-创建过程总结"><a href="#sqlsession-创建过程总结" class="header-anchor">#</a> SqlSession 创建过程总结</h1> <p><img src="https://img-blog.csdn.net/20170623205900852" alt=""></p> <ol><li>首先<code>SqlSessionFactoryBuilder</code>去读取 mybatis 的配置文件，然后 build 一个<code>DefaultSqlSessionFactory</code>，即得到<code>SqlSessionFactory</code></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {
    try {
      //通过XMLConfigBuilder解析配置文件，解析的配置相关信息都会封装为一个Configuration对象
      XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
      //然后返回一个DefaultSqlSessionFactory
      return build(parser.parse());
    } catch (Exception e) {
      throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);
    } finally {
      ErrorContext.instance().reset();
      try {
        inputStream.close();
      } catch (IOException e) {
        // Intentionally ignore. Prefer previous error.
      }
    }
  }

 //得到DefaultSqlSessionFactory
 public SqlSessionFactory build(Configuration config) {
   return new DefaultSqlSessionFactory(config);
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>根据 xml 或者注解生成 MappedStatement 对象放在 Configurationd 对象里属性为 mappedStatements 的一个 HashMap，存储时 key =全限定类名+⽅法名，value =对应的 MappedStatement 对象</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * MappedStatement 映射
 *
 * KEY：`${namespace}.${id}`
 */
protected final Map&lt;String, MappedStatement&gt; mappedStatements = new StrictMap&lt;&gt;(&quot;Mapped Statements collection&quot;);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li>Configuration 配置类包含大量 new 方法创建各种类</li></ol> <p><img src="https://img-blog.csdnimg.cn/img_convert/cca2f536e308d15f4723eccc251cafde.png#pic_center" alt="image-20230222155019796"></p> <p>每创建一个新的对象都会<strong>应用插件</strong>生成一个代理对象。以 Executor 为例，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>	/**
     * 创建 Executor 对象
     *
     * @param transaction 事务对象
     * @param executorType 执行器类型
     * @return Executor 对象
     */
    public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
        // 获得执行器类型
        executorType = executorType == null ? defaultExecutorType : executorType; // 使用默认
        executorType = executorType == null ? ExecutorType.SIMPLE : executorType; // 使用 ExecutorType.SIMPLE
        // 创建对应实现的 Executor 对象
        Executor executor;
        if (ExecutorType.BATCH == executorType) {
            executor = new BatchExecutor(this, transaction);
        } else if (ExecutorType.REUSE == executorType) {
            executor = new ReuseExecutor(this, transaction);
        } else {
            executor = new SimpleExecutor(this, transaction);
        }
        // 如果开启缓存，创建 CachingExecutor 对象，进行包装
        if (cacheEnabled) {
            executor = new CachingExecutor(executor);
        }
        // 应用插件
        executor = (Executor) interceptorChain.pluginAll(executor);
        return executor;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ol start="3"><li><p>获取到<code>SqlSessionFactory</code>之后，就可以利用<code>SqlSessionFactory</code>方法的<code>openSession</code>来获取<code>SqlSession</code>对象了。</p> <p>得到<code>SqlSession</code>对象之后就可以利用<code>SqlSession</code>内部的方法进行 CRUD 操作了。</p></li> <li><p>注意一点，<code>Connection</code>对象是在<code>SqlSession</code>对象创建之后进行 CURD 操作中创建的。深入查找之后找到在<code>ManagedTransaction</code>类中找到获取<code>Connection</code>对象的关键代码如下：</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>  protected void openConnection() throws SQLException {
    if (log.isDebugEnabled()) {
      log.debug(&quot;Opening JDBC Connection&quot;);
    }
    //dataSource 来源有三种，JndiDatasource，PooledDataSource，UnpooledDataSource，配置文件中定义
    this.connection = this.dataSource.getConnection();
    if (this.level != null) {
      this.connection.setTransactionIsolation(this.level.getLevel());
    }
  }

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>SqlSession 每执行完一个 sql 就会关闭链接(放入连接池)。如果不想让他关闭，可以参考<a href="https://andyoung.blog.csdn.net/article/details/109848566" target="_blank" rel="noopener noreferrer">MyBatis 千万级数据查询解决方案，避免 OOM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="执行-sql-流程"><a href="#执行-sql-流程" class="header-anchor">#</a> 执行 sql 流程</h1> <ul><li><ol><li>调用 SqlSession 的 Executor 执行 sql</li></ol> <ul><li><p>根据 ID 获取 MappedStatement,</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>MappedStatement ms = configuration.getMappedStatement(statement);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><ol start="2"><li>Executor 调用 StatementHandler 创建 JDBC 的 Statement（PreparedStatement）连接对象，并且执行 sql 获取到 ResultSetHandler</li></ol></li> <li><ol start="3"><li>ResultSetHandler 装换成返回的具体对象</li></ol></li></ul> <h1 id="mybatis-成员层次-职责"><a href="#mybatis-成员层次-职责" class="header-anchor">#</a> MyBatis 成员层次&amp;职责</h1> <p><img src="https://img-blog.csdnimg.cn/img_convert/c12ce1266375c59ae348554182ca413d.png#pic_center" alt="图片"></p> <ol><li>SqlSession 作为 MyBatis 工作的主要顶层 API，表示和数据库交互的会话，完成必要数据库增删改查功能</li> <li>Executor MyBatis 执行器，是 MyBatis 调度的核心，负责 SQL 语句的生成和查询缓存的维护</li> <li>StatementHandler 封装了 JDBC Statement 操作，负责对 JDBCstatement 的操作，如设置参数、将 Statement 结果集转换成 List 集合。</li> <li>ParameterHandler 负责对用户传递的参数转换成 JDBC Statement 所需要的参数</li> <li>ResultSetHandler *负责将 JDBC 返回的 ResultSet 结果集对象转换成 List 类型的集合；</li> <li>TypeHandler 负责 java 数据类型和 jdbc 数据类型之间的映射和转换</li> <li>MappedStatement MappedStatement 维护了一条&lt;select|update|delete|insert&gt;节点的封</li> <li>SqlSource 负责根据用户传递的 parameterObject，动态地生成 SQL 语句，将信息封装到 BoundSql 对象中，并返回</li> <li>BoundSql 表示动态生成的 SQL 语句以及相应的参数信息</li> <li>Configuration MyBatis 所有的配置信息都维持在 Configuration 对象之中</li></ol> <p><img src="https://img-blog.csdnimg.cn/20200923195343993.png#pic_center" alt="MyBatis 架构与原理到执行流程"></p> <h1 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h1> <p>https://blog.csdn.net/zwx900102/article/details/108455514</p> <p><a href="https://blog.csdn.net/agonie201218/article/details/129157261" target="_blank" rel="noopener noreferrer">JDBC 简单的示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/andanyoung/source/tree/main/mybatis" target="_blank" rel="noopener noreferrer">手写 mybatis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://andyoung.blog.csdn.net/article/details/125059190" target="_blank" rel="noopener noreferrer">mybatis 最常用的 SqlSessionFactory 和 SqlSession，你真的了解吗？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/andanyang/vuepress-theme-vdoing/edit/master/docs/MyBatis/0010.MyBatis 架构与原理到执行流程.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/05/29, 03:30:39</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/jdbc-demo/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JDBC简单的示例</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/jdbc-demo/" class="prev">JDBC简单的示例</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/977ce6/"><div>
            多线程环境下，HashMap为什么会出现死循环
            <!----></div></a> <span class="date">05-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/java-lru/"><div>
            java 实现LRU 算法
            <!----></div></a> <span class="date">05-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/d6064c/"><div>
            讲一讲什么是 MMAP
            <!----></div></a> <span class="date">05-09</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1218853253@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/andanyang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>Young | <a href="https://github.com/andanyoung/young-blog/blob/master/LICENSE" target="_blank">MIT License</a> <br/> <a  href="https://beian.miit.gov.cn/" target="_blank">浙ICP备20002744号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.4cd86b41.js" defer></script><script src="/assets/js/2.d1119784.js" defer></script><script src="/assets/js/20.40ed6860.js" defer></script>
  </body>
</html>
