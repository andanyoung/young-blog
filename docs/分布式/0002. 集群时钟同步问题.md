---
title: 集群时钟同步问题
date: 2023-03-28 16:29:56
permalink: /pages/Cluster-time/
categories:
  - 分布式
tags:
  -
author:
  name: andanyang
  link: https://github.com/andanyoung
---

### 1、时钟不同步导致的问题

时钟此处指服务器时间，如果集群中各个服务器时钟不⼀致势必导致⼀系列问题，试想 “集群是各个服务器⼀起团队化作战，⼤家工作都不在⼀个点上，岂不乱了套！”

举⼀个例⼦，电商网站业务中，新增⼀条订单，那么势必会在订单表中增加了⼀条记录，该条记录中应该会有“下单时间”这样的字段，往往我们会在程序中获取当前系统时间插⼊到数据库或者直接从数据库服务器获取时间。那我们的订单⼦系统是集群化部署，或者我们的数据库也是分库分表的集群化部署，然⽽他们的系统时钟缺不⼀致，⽐如有⼀台服务器的时间是昨天，那么这个时候下单时间就成了昨天，那我们的数据将会混乱！如下

![image-20230328163202071](http://md7.admin4j.com/blog/image-20230328163202071.png)

### 2、集群时钟同步配置

- 集群时钟同步思路

  - 分布式集群中各个服务器节点都可以连接互联网

    场景一：各个节点都可以访问互联网，各自同步国家授时中心/时间服务器

  ![image-20230328163313106](http://md7.admin4j.com/blog/image-20230328163313106.png)

  操作⽅式：

  ```java
  #使⽤ ntpdate 网络时间同步命令
  ntpdate -u ntp.api.bz #从⼀个时间服务器同步时间
  ```

  windows 有计划任务

  Linux 也有定时任务，crond，可以使⽤ linux 的定时任务，每隔 10 分钟执⾏⼀次 ntpdate 命令

  - 分布式集群中某⼀个服务器节点可以访问互联网或者所有节点都不能够访问互联网

    场景二和场景三：把 node1 作为局域网内的时间服务器，其他服务器从 node1 上同步时间

    ![image-20230328163354748](http://md7.admin4j.com/blog/image-20230328163354748.png)

  操作⽅式：

  1）选取集群中的⼀个服务器节点 A(172.17.0.17)作为时间服务器（整个集群时间从这台服务器同步，如果这台服务器能够访问互联网，可以让这台服务器和网络时间保持同步，如果不能就⼿动设置⼀个时间）

  - ⾸先设置好 A 的时间
  - 把 A 配置为时间服务器（修改/etc/ntp.conf ⽂件）

```java
1、如果有 restrict default ignore，注释掉它
2、添加如下⼏⾏内容
 restrict 172.17.0.0 mask 255.255.255.0 nomodify notrap # 放开局域网同步功能,172.17.0.0是你的局域网网段
 server 127.127.1.0 # local clock
 fudge 127.127.1.0 stratum 10
3、重启⽣效并配置ntpd服务开机⾃启动
service ntpd restart
 chkconfig ntpd on
```

- 集群中其他节点就可以从 A 服务器同步时间了

  ```
  ntpdate 172.17.0.17
  ```
