---
title: MySQL索引原理
date: 2023-05-02 10:40:29
permalink: /pages/mysql-index/
categories:
  - mysql
tags:
  -
author:
  name: andanyang
  link: https://github.com/andanyoung
---

# 1. 索引类型

索引可以提升查询速度，会影响 where 查询，以及 order by 排序。MySQL 索引类型如下：

- 从索引存储结构划分：B Tree 索引、Hash 索引、FULLTEXT 全文索引、R Tree 索引
- 从应用层次划分：普通索引、唯一索引、主键索引、复合索引
- 从索引键值类型划分：主键索引、辅助索引（二级索引）
- 从数据存储和索引键值逻辑关系划分：聚集索引（聚簇索引）、非聚集索引（非聚簇索引）

## 1.1 普通索引

这是最基本的索引类型，基于普通字段建立的索引，没有任何限制。

创建普通索引的方法如下：

- CREATE INDEX <索引的名字> ON tablename (字段名);
- ALTER TABLE tablename ADD INDEX [索引的名字] (字段名);
- CREATE TABLE tablename ( [...], INDEX [索引的名字] (字段名) );

## 1.2 唯一索引

与"普通索引"类似，不同的就是：索引字段的值必须唯一，但允许有空值 。在创建或修改表时追加唯一约束，就会自动创建对应的唯一索引。

创建唯一索引的方法如下：

- CREATE UNIQUE INDEX <索引的名字> ON tablename (字段名);
- ALTER TABLE tablename ADD UNIQUE INDEX [索引的名字] (字段名);
- CREATE TABLE tablename ( [...], UNIQUE [索引的名字] (字段名) ;

## 1.3 主键索引

它是一种特殊的唯一索引，不允许有空值。在创建或修改表时追加主键约束即可，每个表只能有一个主 键。

创建主键索引的方法如下：

- CREATE TABLE tablename ( [...], PRIMARY KEY (字段名) );
- ALTER TABLE tablename ADD PRIMARY KEY (字段名);

## 1.4 复合索引

单一索引是指索引列为一列的情况，即新建索引的语句只实施在一列上；用户可以在多个列上建立索引，这种索引叫做组复合索引（组合索引）。复合索引可以代替多个单一索引，相比多个单一索引复合索引所需的开销更小。

索引同时有两个概念叫做窄索引和宽索引，窄索引是指索引列为 1-2 列的索引，宽索引也就是索引列超 过 2 列的索引，设计索引的一个重要原则就是能用窄索引不用宽索引，因为窄索引往往比组合索引更有效。

创建组合索引的方法如下：

- CREATE INDEX <索引的名字> ON tablename (字段名 1，字段名 2...);
- ALTER TABLE tablename ADD INDEX [索引的名字] (字段名 1，字段名 2...);
- CREATE TABLE tablename ( [...], INDEX [索引的名字] (字段名 1，字段名 2...) );

复合索引使用注意事项：

- 何时使用复合索引，要根据 where 条件建索引，注意不要过多使用索引，过多使用会对更新操作效 率有很大影响。
- 如果表已经建立了(col1，col2)，就没有必要再单独建立（col1）；如果现在有(col1)索引，如果查询需要 col1 和 col2 条件，可以建立(col1,col2)复合索引，对于查询有一定提高。

## 1.5 全文索引

查询操作在数据量比较少时，可以使用 like 模糊查询，但是对于大量的文本数据检索，效率很低。如果 使用全文索引，查询速度会比 like 快很多倍。在 MySQL 5.6 以前的版本，只有 MyISAM 存储引擎支持全 文索引，从 MySQL 5.6 开始 MyISAM 和 InnoDB 存储引擎均支持。

创建全文索引的方法如下：

- CREATE FULLTEXT INDEX <索引的名字> ON tablename (字段名);
- ALTER TABLE tablename ADD FULLTEXT [索引的名字] (字段名);
- CREATE TABLE tablename ( [...], FULLTEXT KEY [索引的名字] (字段名) ;

和常用的 like 模糊查询不同，全文索引有自己的语法格式，使用 match 和 against 关键字，比如

```
select * from user where match(name) against('aaa');
```

全文索引使用注意事项：

- 全文索引必须在字符串、文本字段上建立。
- 全文索引字段值必须在最小字符和最大字符之间的才会有效。（innodb：3-84；myisam：4- 84）
- 全文索引字段值要进行切词处理，按 syntax 字符进行切割，例如 b+aaa，切分成 b 和 aaa 全文索引匹配查询，
- 默认使用的是等值匹配，例如 a 匹配 a，不会匹配 ab,ac。如果想匹配可以在布尔模式下搜索 a\*

```
select * from user where match(name) against('a*' in boolean mode);
```

# 2. 索引原理

MySQL 官方对索引定义：是存储引擎用于快速查找记录的一种数据结构。需要额外开辟空间和数据维护工作。

索引是物理数据页存储，在数据文件中（InnoDB，ibd 文件），利用数据页(page)存储。 索引可以加快检索速度，但是同时也会降低增删改操作速度，索引维护需要代价。 索引涉及的理论知识：二分查找法、Hash 和 B+Tree。

## 2.1 二分查找法

二分查找法也叫作折半查找法，它是在有序数组中查找指定数据的搜索算法。它的优点是等值查询、范围查询性能优秀，缺点是更新数据、新增数据、删除数据维护成本高。

- 首先定位 left 和 right 两个指针
- 计算(left+right)/2
- 判断除 2 后索引位置值与目标值的大小比对
- 索引位置值大于目标值就-1，right 移动；如果小于目标值就+1，left 移动

举个例子，下面的有序数组有 17 个值，查找的目标值是 7，过程如下：

- 第一次查找

  ![image-20230502102331528](http://md7.admin4j.com/blog/mysql/image-20230502102331528.png)

- 第二次查找

![image-20230502102400518](http://md7.admin4j.com/blog/mysql/image-20230502102400518.png)

- 第三次查找

  ![image-20230502102419943](http://md7.admin4j.com/blog/mysql/image-20230502102419943.png)

- 第四次查找

![image-20230502102436244](http://md7.admin4j.com/blog/mysql/image-20230502102436244.png)

## 2.2 Hash 结构

Hash 底层实现是由 Hash 表来实现的，是根据键值 存储数据的结构。非常适合根据 key 查找 value 值，也就是单个 key 查询，或者说等值查询。其结构如下所示：

![image-20230502102521083](http://md7.admin4j.com/blog/mysql/image-20230502102521083.png)

从上面结构可以看出，Hash 索引可以方便的提供等值查询，但是对于范围查询就需要全表扫描了。 Hash 索引在 MySQL 中 Hash 结构主要应用在 Memory 原生的 Hash 索引 、InnoDB 自适应哈希索引。

InnoDB 提供的自适应哈希索引功能强大，接下来重点描述下 InnoDB 自适应哈希索引。 InnoDB 自适应哈希索引是为了提升查询效率，InnoDB 存储引擎会监控表上各个索引页的查询，当 InnoDB 注意到某些索引值访问非常频繁时，会在内存中基于 B+Tree 索引再创建一个哈希索引，使得内存中的 B+Tree 索引具备哈希索引的功能，即能够快速定值访问频繁访问的索引页。

InnoDB 自适应哈希索引：在使用 Hash 索引访问时，一次性查找就能定位数据，等值查询效率要优于 B+Tree。 自适应哈希索引的建立使得 InnoDB 存储引擎能自动根据索引页访问的频率和模式自动地为某些热点页 建立哈希索引来加速访问。另外 InnoDB 自适应哈希索引的功能，用户只能选择开启或关闭功能，无法进行人工干涉。

```
show engine innodb status \G;
show variables like '%innodb_adaptive%';
```

## 2.3 B+Tree 结构

MySQL 数据库索引采用的是 B+Tree 结构，在 B-Tree 结构上做了优化改造。

- B-Tree 结构

  - 索引值和 data 数据分布在整棵树结构中
  - 每个节点可以存放多个索引值及对应的 data 数据
  - 树节点中的多个索引值从左到右升序排列

  ![image-20230502102804200](http://md7.admin4j.com/blog/mysql/image-20230502102804200.png)

B 树的搜索：从根节点开始，对节点内的索引值序列采用二分法查找，如果命中就结束查找。没有 命中会进入子节点重复查找过程，直到所对应的的节点指针为空，或已经是叶子节点了才结束。

- B+Tree 结构

  - 非叶子节点不存储 data 数据，只存储索引值，这样便于存储更多的索引值
  - 叶子节点包含了所有的索引值和 data 数据
  - 叶子节点用指针连接，提高区间的访问性能

  ![image-20230502102915548](http://md7.admin4j.com/blog/mysql/image-20230502102915548.png)

  相比 B 树，B+树进行范围查找时，只需要查找定位两个节点的索引值，然后利用叶子节点的指针进 行遍历即可。而 B 树需要遍历范围内所有的节点和数据，显然 B+Tree 效率高。

## 2.4 聚簇索引和辅助索引

聚簇索引和非聚簇索引：B+Tree 的叶子节点存放主键索引值和行记录就属于聚簇索引；如果索引值和行记录分开存放就属于非聚簇索引。

主键索引和辅助索引：B+Tree 的叶子节点存放的是主键字段值就属于主键索引；如果存放的是非主键值就属于辅助索引（二级索引）。

在 InnoDB 引擎中，主键索引采用的就是聚簇索引结构存储。

- 聚簇索引（聚集索引）

  聚簇索引是一种数据存储方式，InnoDB 的聚簇索引就是按照主键顺序构建 B+Tree 结构。B+Tree 的叶子节点就是行记录，行记录和主键值紧凑地存储在一起。 这也意味着 InnoDB 的主键索引就是数据表本身，它按主键顺序存放了整张表的数据，占用的空间就是整个表数据量的大小。通常说的**主键索引**就是聚集索引。

  InnoDB 的表要求必须要有聚簇索引：

  - 如果表定义了主键，则主键索引就是聚簇索引
  - 如果表没有定义主键，则第一个非空 unique 列作为聚簇索引
  - 否则 InnoDB 会从建一个隐藏的 row-id 作为聚簇索引

- 辅助索引

  InnoDB 辅助索引，也叫作二级索引，是根据索引列构建 B+Tree 结构。但在 B+Tree 的叶子节点中只存了索引列和主键的信息。二级索引占用的空间会比聚簇索引小很多， 通常创建辅助索引就是为了提升查询效率。一个表 InnoDB 只能创建一个聚簇索引，但可以创建多个辅助索引。

![image-20230502103503206](http://md7.admin4j.com/blog/mysql/image-20230502103503206.png)

- 非聚簇索引

  与 InnoDB 表存储不同，MyISAM 数据表的索引文件和数据文件是分开的，被称为非聚簇索引结构。

  ![image-20230502103559888](http://md7.admin4j.com/blog/mysql/image-20230502103559888.png)

# 参考

[索引很难么？带你从头到尾捋一遍 MySQL 索引结构，不信你学不会](https://andyoung.blog.csdn.net/article/details/124859896)

[阿里规范说 MySQL 单表行数不要超过 2000w，为啥?](https://andyoung.blog.csdn.net/article/details/122333014)

[InnoDB 原理篇：聊聊数据页变成索引这件事](https://andyoung.blog.csdn.net/article/details/126094568)

[MySQL 索引底层：B+树详解](https://andyoung.blog.csdn.net/article/details/123897779)
